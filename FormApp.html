<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="FSC, WRC, and WLP Management System - Form Entry Portal">
  <title>FSC / WRC / WLP Management System</title>

  <style>
    /* ================================================================
       CLEAN PAPER WHITE THEME - PROFESSIONAL MINIMAL STYLING
       ================================================================ */

    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --color-primary: #2c3e50;
      --color-secondary: #34495e;
      --color-border: #d1d5db;
      --color-border-focus: #6b7280;
      --color-bg: #ffffff;
      --color-bg-alt: #f9fafb;
      --color-text: #1f2937;
      --color-text-light: #6b7280;
      --color-success: #10b981;
      --color-success-bg: #d1fae5;
      --color-error: #ef4444;
      --color-error-bg: #fee2e2;
      --color-disabled: #e5e7eb;
      --color-warning: #f59e0b;
      --color-warning-bg: #fef3c7;
      --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
      --gap: 16px;
      --input-height: 40px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--color-bg-alt);
      color: var(--color-text);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: var(--color-bg);
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      overflow: hidden;
    }

    /* Header */
    .header {
      background: var(--color-primary);
      color: white;
      padding: 28px 32px;
      border-bottom: 3px solid var(--color-secondary);
    }
    .header h1 { font-size: 1.75rem; font-weight: 600; margin-bottom: 6px; letter-spacing: -0.025em; }
    .header p { font-size: 0.95rem; opacity: 0.9; font-weight: 400; }

    /* Tabs */
    .tabs {
      display: flex;
      background: var(--color-bg-alt);
      border-bottom: 1px solid var(--color-border);
      overflow-x: auto;
    }
    .tab {
      flex: 1; min-width: 140px; padding: 16px 20px;
      text-align: center; font-weight: 500; font-size: 0.95rem;
      cursor: pointer; background: transparent; color: var(--color-text-light);
      border: none; border-bottom: 3px solid transparent;
      transition: all 0.2s ease; white-space: nowrap;
    }
    .tab:hover { background: rgba(0,0,0,0.02); color: var(--color-text); }
    .tab.active {
      background: var(--color-bg); color: var(--color-primary);
      border-bottom-color: var(--color-primary); font-weight: 600;
    }

    /* Form Content */
    .form-content { padding: 32px; }
    .form-panel { display: none; }
    .form-panel.active { display: block; }
    .form-title {
      font-size: 1.5rem; font-weight: 600; color: var(--color-primary);
      margin-bottom: 24px; padding-bottom: 12px;
      border-bottom: 2px solid var(--color-bg-alt);
    }

    /* Form Sections */
    .form-section { margin-bottom: 28px; }
    .section-title {
      font-size: 1.05rem; font-weight: 600; color: var(--color-secondary);
      margin-bottom: 16px; padding-left: 12px;
      border-left: 3px solid var(--color-primary);
    }

    /* Form Layout */
    .form-group { margin-bottom: 4px; }
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: var(--gap);
      margin-bottom: var(--gap);
    }
    .form-row-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--gap);
      margin-bottom: var(--gap);
    }
    .form-row-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--gap);
      margin-bottom: var(--gap);
    }
    .form-row-full {
      margin-bottom: var(--gap);
    }

    /* Labels */
    label {
      display: block; font-size: 0.9rem; font-weight: 500;
      color: var(--color-text); margin-bottom: 6px;
    }
    label .req { color: var(--color-error); margin-left: 2px; }
    label .hint {
      color: var(--color-text-light); font-weight: 400;
      font-size: 0.85rem; margin-left: 4px;
    }

    /* Inputs */
    input[type="text"], input[type="number"], input[type="date"],
    input[type="tel"], input[type="email"], select, textarea {
      width: 100%; font-family: inherit; font-size: 0.95rem;
      padding: 9px 12px; height: var(--input-height);
      border: 1px solid var(--color-border); border-radius: 6px;
      background: var(--color-bg); color: var(--color-text);
      transition: all 0.2s ease;
    }
    textarea { height: auto; min-height: 80px; resize: vertical; }
    input:focus, select:focus, textarea:focus {
      outline: none; border-color: var(--color-border-focus);
      box-shadow: 0 0 0 3px rgba(107,114,128,0.1);
    }
    input:disabled, select:disabled, textarea:disabled {
      background: var(--color-disabled); color: var(--color-text-light); cursor: not-allowed;
    }
    input::placeholder, textarea::placeholder { color: #9ca3af; }
    select {
      cursor: pointer; appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 12px center;
      padding-right: 36px;
    }

    .help-text {
      display: block; font-size: 0.8rem; color: var(--color-text-light);
      margin-top: 4px; font-style: italic;
    }

    /* Field-with-help (WRC ? button) */
    .field-with-help {
      display: flex; align-items: flex-end; gap: 8px;
    }
    .field-with-help .form-group { flex: 1; }
    .help-button {
      width: 36px; height: var(--input-height); flex-shrink: 0;
      border-radius: 50%; border: 1px solid var(--color-border);
      background: var(--color-bg); color: var(--color-text-light);
      font-size: 1rem; font-weight: 600; cursor: pointer;
      transition: all 0.2s ease; display: flex;
      align-items: center; justify-content: center;
    }
    .help-button:hover {
      background: var(--color-primary); color: white;
      border-color: var(--color-primary); transform: scale(1.1);
    }

    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      font-family: inherit; font-size: 1rem; font-weight: 500;
      padding: 12px 28px; border: none; border-radius: 6px;
      cursor: pointer; transition: all 0.2s ease;
    }
    .btn-primary {
      background: var(--color-primary); color: white; box-shadow: var(--shadow-sm);
    }
    .btn-primary:hover { background: var(--color-secondary); box-shadow: var(--shadow-md); transform: translateY(-1px); }
    .btn-primary:active { transform: translateY(0); }
    .btn-primary:disabled { background: var(--color-disabled); color: var(--color-text-light); cursor: not-allowed; transform: none; }
    .btn-secondary { background: transparent; color: var(--color-text); border: 1px solid var(--color-border); }
    .btn-secondary:hover { background: var(--color-bg-alt); }
    .form-actions {
      display: flex; gap: 12px; margin-top: 28px; padding-top: 24px;
      border-top: 1px solid var(--color-border);
    }

    /* Messages */
    .message {
      display: none; padding: 16px 18px; border-radius: 8px;
      margin-bottom: 20px; font-size: 0.95rem; animation: slideDown 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    @keyframes slideDown { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
    .message.visible { display: block; }
    .message.success { background: #d1fae5; color: #065f46; border: 1px solid #34d399; border-left: 4px solid #10b981; }
    .message.error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; border-left: 4px solid #ef4444; }
    .message-content { display: flex; align-items: center; gap: 12px; }
    .message-icon { 
      flex-shrink: 0; font-size: 1.4rem; font-weight: bold;
      width: 28px; height: 28px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
    }
    .message.success .message-icon { background: #10b981; color: white; }
    .message.error .message-icon { background: #ef4444; color: white; }
    .message-text { flex: 1; line-height: 1.5; }

    /* Validation */
    .validation-banner {
      display: none; padding: 14px 16px; border-radius: 6px;
      margin-bottom: 20px; background: var(--color-warning-bg);
      border: 1px solid var(--color-warning); color: #92400e;
    }
    .validation-banner.visible { display: block; }
    .validation-banner-title { font-size: 0.95rem; font-weight: 600; margin-bottom: 8px; }
    .validation-banner-list { list-style: disc; padding-left: 20px; font-size: 0.9rem; }
    .field-error { border-color: var(--color-error) !important; box-shadow: 0 0 0 2px rgba(239,68,68,0.15) !important; }
    .error-message { display: block; font-size: 0.8rem; color: var(--color-error); margin-top: 4px; }

    /* Spinner */
    .spinner {
      display: inline-block; width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,0.3); border-top-color: white;
      border-radius: 50%; animation: spin 0.7s linear infinite;
      margin-left: 8px; vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* File Upload */
    .file-upload-section {
      padding: 20px; background: var(--color-bg-alt);
      border: 2px dashed var(--color-border); border-radius: 8px;
      transition: all 0.2s ease;
    }
    .file-upload-section:hover { border-color: var(--color-border-focus); background: #f3f4f6; }
    .file-input-wrapper { position: relative; }
    .file-input-label {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 10px 20px; background: var(--color-bg);
      border: 1px solid var(--color-border); border-radius: 6px;
      cursor: pointer; font-weight: 500; transition: all 0.2s ease;
    }
    .file-input-label:hover { background: var(--color-bg-alt); border-color: var(--color-border-focus); }
    input[type="file"] { position: absolute; opacity: 0; width: 0; height: 0; }
    .file-info {
      margin-top: 12px; padding: 10px; background: var(--color-bg);
      border-radius: 6px; font-size: 0.9rem; color: var(--color-text);
    }
    .file-name { font-weight: 500; color: var(--color-primary); }
    .file-size { color: var(--color-text-light); font-size: 0.85rem; margin-left: 8px; }
    .remove-file-btn {
      margin-left: 12px; padding: 4px 12px; background: transparent;
      border: 1px solid var(--color-border); border-radius: 4px;
      font-size: 0.85rem; cursor: pointer; color: var(--color-error);
      transition: all 0.2s ease;
    }
    .remove-file-btn:hover { background: var(--color-error-bg); border-color: var(--color-error); }
    .image-preview { margin-top: 16px; text-align: center; }
    .image-preview img { max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: var(--shadow-md); border: 1px solid var(--color-border); }
    .upload-progress {
      margin-top: 12px; padding: 12px; background: var(--color-warning-bg);
      border: 1px solid var(--color-warning); border-radius: 6px;
      color: #92400e; font-size: 0.9rem; display: none;
    }
    .upload-progress.visible { display: block; }
    .file-restrictions { margin-top: 8px; font-size: 0.8rem; color: var(--color-text-light); font-style: italic; }
    .file-required-note { margin-top: 4px; font-size: 0.85rem; color: var(--color-error); }

    /* Modal */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); z-index: 1000;
      align-items: center; justify-content: center; padding: 20px;
    }
    .modal-overlay.active { display: flex; }
    .modal-dialog {
      background: var(--color-bg); border-radius: 8px;
      box-shadow: var(--shadow-lg); max-width: 560px; width: 100%;
      max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
    .modal-header {
      padding: 20px 24px; border-bottom: 1px solid var(--color-border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--color-primary); margin: 0; }
    .modal-close {
      width: 32px; height: 32px; border-radius: 4px; border: none;
      background: transparent; color: var(--color-text-light); font-size: 1.5rem;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .modal-close:hover { background: var(--color-bg-alt); color: var(--color-text); }
    .modal-body { padding: 24px; }
    .modal-text { font-size: 0.95rem; line-height: 1.6; color: var(--color-text); margin-bottom: 20px; }
    .modal-email {
      display: inline-block; font-weight: 600; color: var(--color-primary);
      text-decoration: none; padding: 2px 4px; border-radius: 3px; background: var(--color-bg-alt);
    }
    .modal-email:hover { text-decoration: underline; }
    .required-details {
      margin: 20px 0; padding: 16px; background: var(--color-bg-alt);
      border-left: 3px solid var(--color-primary); border-radius: 4px;
    }
    .required-details h4 { font-size: 0.9rem; font-weight: 600; color: var(--color-secondary); margin: 0 0 12px 0; }
    .required-details ul { list-style: none; padding: 0; margin: 0; }
    .required-details li {
      padding: 6px 0; font-size: 0.9rem; color: var(--color-text);
      position: relative; padding-left: 20px;
    }
    .required-details li::before { content: "\2022"; position: absolute; left: 8px; color: var(--color-primary); font-weight: bold; }
    .modal-actions { display: flex; gap: 12px; margin-top: 24px; }
    .btn-email {
      flex: 1; background: var(--color-primary); color: white;
      text-decoration: none; padding: 12px 24px; border-radius: 6px;
      font-weight: 500; text-align: center; transition: all 0.2s ease;
      border: none; cursor: pointer;
    }
    .btn-email:hover { background: var(--color-secondary); transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn-cancel {
      padding: 12px 24px; background: transparent; border: 1px solid var(--color-border);
      border-radius: 6px; color: var(--color-text); font-weight: 500;
      cursor: pointer; transition: all 0.2s ease;
    }
    .btn-cancel:hover { background: var(--color-bg-alt); }

    /* Responsive */
    @media (max-width: 640px) {
      body { padding: 10px; }
      .form-content { padding: 20px; }
      .form-row, .form-row-2, .form-row-3 { grid-template-columns: 1fr; }
      .header h1 { font-size: 1.4rem; }
      .tab { font-size: 0.85rem; padding: 14px 12px; }
      .modal-dialog { max-width: 100%; margin: 0 10px; }
      .modal-actions { flex-direction: column; }
    }

    /* Accessibility */
    .sr-only {
      position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;
    }
    *:focus-visible { outline: 2px solid var(--color-primary); outline-offset: 2px; }

    /* Radio & Checkbox Groups */
    .radio-group, .checkbox-group { display: flex; flex-wrap: wrap; gap: 12px 24px; padding: 8px 0; }
    .radio-label, .checkbox-label { display: flex; align-items: center; gap: 6px; font-size: 0.9rem; cursor: pointer; font-weight: 400; }
    .radio-label input[type="radio"], .checkbox-label input[type="checkbox"] { width: auto; height: auto; margin: 0; accent-color: var(--color-primary); }

    /* Parts Table */
    .parts-table { width: 100%; border-collapse: collapse; margin-bottom: 12px; }
    .parts-table th { padding: 10px 12px; background: var(--color-bg-alt); font-size: 0.85rem; font-weight: 600; text-align: left; border: 1px solid var(--color-border); }
    .parts-table td { padding: 4px; border: 1px solid var(--color-border); }
    .parts-table td input { border: none; background: transparent; height: 32px; padding: 4px 8px; font-family: inherit; font-size: 0.9rem; width: 100%; }
    .parts-table td input:focus { outline: 2px solid var(--color-primary); outline-offset: -2px; border-radius: 3px; }
    .btn-remove-row { background: none; border: none; color: var(--color-error); font-size: 1.3rem; cursor: pointer; padding: 4px 10px; border-radius: 4px; transition: background 0.2s; }
    .btn-remove-row:hover { background: var(--color-error-bg); }

    /* PDF Download Card */
    .pdf-download-section { margin-top: 24px; }
    .pdf-download-card {
      display: flex; align-items: center; gap: 16px; padding: 20px;
      background: #ecfdf5; border: 1px solid #6ee7b7; border-radius: 8px;
    }
    .pdf-icon { font-size: 2rem; }
    .pdf-download-info { flex: 1; }
    .pdf-download-title { font-weight: 600; color: #065f46; font-size: 1rem; margin: 0; }
    .pdf-download-id { color: #047857; font-size: 0.9rem; margin: 4px 0 0; }

    /* Signature Pads */
    .signature-pad-container { position: relative; }
    .signature-canvas {
      border: 2px solid var(--color-border);
      border-radius: 6px;
      background: #fff;
      cursor: crosshair;
      display: block;
      touch-action: none;
    }
    .signature-canvas:hover { border-color: var(--color-primary); }
    .btn-clear-sig {
      margin-top: 4px;
      padding: 4px 12px;
      font-size: 0.8rem;
      background: var(--color-bg-alt);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      cursor: pointer;
      color: var(--color-text);
      transition: all 0.2s;
    }
    .btn-clear-sig:hover { background: var(--color-error-bg); color: var(--color-error); border-color: var(--color-error); }

    /* WCF Post-Submit Modal */
    .wcf-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s;
    }
    .wcf-modal-overlay.active { display: flex; }
    .wcf-modal {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
      max-width: 500px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      animation: slideUp 0.3s;
    }
    .wcf-modal-header {
      padding: 24px 24px 16px;
      border-bottom: 1px solid var(--color-border);
    }
    .wcf-modal-title {
      margin: 0;
      font-size: 1.5rem;
      color: var(--color-success);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .wcf-modal-body {
      padding: 24px;
    }
    .wcf-modal-info {
      background: var(--color-bg-alt);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .wcf-modal-info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--color-border);
    }
    .wcf-modal-info-row:last-child { border-bottom: none; }
    .wcf-modal-info-label {
      font-weight: 600;
      color: #666;
      font-size: 0.9rem;
    }
    .wcf-modal-info-value {
      color: var(--color-text);
      font-weight: 500;
      font-size: 0.9rem;
    }
    .wcf-modal-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .wcf-modal-btn {
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .wcf-modal-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .wcf-modal-btn-primary {
      background: var(--color-primary);
      color: #fff;
    }
    .wcf-modal-btn-primary:hover:not(:disabled) {
      background: #0056b3;
      transform: translateY(-1px);
    }
    .wcf-modal-btn-secondary {
      background: var(--color-bg-alt);
      color: var(--color-text);
      border: 1px solid var(--color-border);
    }
    .wcf-modal-btn-secondary:hover:not(:disabled) {
      background: #e9ecef;
    }
    .wcf-modal-btn-success {
      background: var(--color-success);
      color: #fff;
    }
    .wcf-modal-btn-success:hover:not(:disabled) {
      background: #218838;
      transform: translateY(-1px);
    }
    .wcf-modal-status {
      padding: 12px;
      border-radius: 6px;
      margin: 16px 0;
      font-size: 0.9rem;
      display: none;
    }
    .wcf-modal-status.show { display: block; }
    .wcf-modal-status.success {
      background: var(--color-success-bg);
      color: var(--color-success);
      border: 1px solid #6ee7b7;
    }
    .wcf-modal-status.error {
      background: var(--color-error-bg);
      color: var(--color-error);
      border: 1px solid #fca5a5;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @media (max-width: 640px) {
      .radio-group, .checkbox-group { flex-direction: column; gap: 8px; }
      .pdf-download-card { flex-direction: column; text-align: center; }
      .signature-canvas { width: 100%; height: 80px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header" role="banner">
      <h1>FSC / WRC / WLP Management System</h1>
      <p>Form Submission Portal</p>
    </header>

    <nav class="tabs" role="tablist" aria-label="Form selection">
      <button class="tab active" role="tab" aria-selected="true" aria-controls="panel-wrc" id="tab-wrc" onclick="switchForm('wrc')">WRC Registration</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="panel-fsc" id="tab-fsc" onclick="switchForm('fsc')">FSC Entry</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="panel-wlp" id="tab-wlp" onclick="switchForm('wlp')">WLP Acknowledgment</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="panel-wcf" id="tab-wcf" onclick="switchForm('wcf')">WCF Claim</button>
    </nav>

    <main class="form-content">

      <!-- ============================================================
           WRC FORM - Warranty Registration Card
           ============================================================ -->
      <div id="panel-wrc" class="form-panel active" role="tabpanel" aria-labelledby="tab-wrc">
        <div id="wrcMessage" class="message" role="alert"></div>
        <div id="wrcValidationBanner" class="validation-banner" role="alert"></div>

        <h2 class="form-title">Warranty Registration Card (WRC)</h2>

        <form id="wrcForm" onsubmit="submitWRCForm(event)">

          <!-- Branch (FIRST) -->
          <div class="form-section">
            <div class="form-row-full">
              <div class="form-group">
                <label for="wrcBranch">Branch <span class="req">*</span></label>
                <select id="wrcBranch" name="wrcBranch" required aria-required="true">
                  <option value="">Select Branch</option>
                  <option value="BACAYAN">GMPC Bacayan</option>
                  <option value="Balamban">Gmpc Balamban</option>
                  <option value="Barili">Gmpc Barili</option>
                  <option value="Bogo">Gmpc Bogo</option>
                  <option value="Bulacao">Gmpc Bulacao</option>
                  <option value="Camotes">Gmpc Camotes</option>
                  <option value="Candijay">Gmpc Candijay</option>
                  <option value="Carmen">Gmpc Carmen</option>
                  <option value="Clarin">Gmpc Clarin</option>
                  <option value="Consolacion">Gmpc Consolacion</option>
                  <option value="Cordova">Gmpc Cordova</option>
                  <option value="Lagtang">Gmpc Lagtang</option>
                  <option value="Lapu-lapu">Gmpc Lapu-Lapu</option>
                  <option value="Liloan">Gmpc Liloan</option>
                  <option value="Pinamungajan">Gmpc Pinamungajan</option>
                  <option value="Pitogo">Gmpc Pitogo</option>
                  <option value="San Fernando">Gmpc San Fernando</option>
                  <option value="Sierra Bullones">Gmpc Sierra Bullones</option>
                  <option value="Talibon">Gmpc Talibon</option>
                  <option value="Toledo">Gmpc Toledo</option>
                  <option value="Tubigon">Gmpc Tubigon</option>
                  <option value="Ubay">Gmpc Ubay</option>
                  <option value="V Rama">Gmpc V Rama</option>
                  <option value="Yati">Gmpc Yati</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Warranty & Engine Identifiers -->
          <div class="form-section">
            <h3 class="section-title">Warranty & Engine Identifiers</h3>
            <div class="form-row-2">
              <div class="field-with-help">
                <div class="form-group">
                  <label for="wrcNo">WRC Number <span class="req">*</span></label>
                  <input type="text" id="wrcNo" name="wrcNo" required aria-required="true" placeholder="Enter WRC number">
                </div>
                <button type="button" class="help-button" onclick="openWrcHelpModal()" aria-label="Help: What if I don't have a WRC Number?" title="What if I don't have a WRC Number?">?</button>
              </div>
              <div class="form-group">
                <label for="engineNo">Engine Number <span class="req">*</span></label>
                <input type="text" id="engineNo" name="engineNo" required aria-required="true" placeholder="Enter engine number">
              </div>
            </div>
          </div>

          <!-- Customer Information -->
          <div class="form-section">
            <h3 class="section-title">Customer Information</h3>
            <div class="form-row-3">
              <div class="form-group">
                <label for="firstName">First Name <span class="req">*</span></label>
                <input type="text" id="firstName" name="firstName" required aria-required="true" placeholder="Juan">
              </div>
              <div class="form-group">
                <label for="mi">Middle Initial <span class="req">*</span></label>
                <input type="text" id="mi" name="mi" maxlength="3" placeholder="D" required aria-required="true">
              </div>
              <div class="form-group">
                <label for="lastName">Last Name <span class="req">*</span></label>
                <input type="text" id="lastName" name="lastName" required aria-required="true" placeholder="Dela Cruz">
              </div>
            </div>
            <div class="form-row-2">
              <div class="form-group">
                <label for="age">Age <span class="req">*</span></label>
                <input type="number" id="age" name="age" min="1" max="120" placeholder="25" required aria-required="true">
              </div>
              <div class="form-group">
                <label for="gender">Gender <span class="req">*</span></label>
                <select id="gender" name="gender" required aria-required="true">
                  <option value="">Select Gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Contact Information -->
          <div class="form-section">
            <h3 class="section-title">Contact Information</h3>
            <div class="form-row-2">
              <div class="form-group">
                <label for="contactNo">Contact Number <span class="req">*</span></label>
                <input type="tel" id="contactNo" name="contactNo" required aria-required="true" placeholder="09XX XXX XXXX" pattern="[0-9]{10,11}">
                <span class="help-text">10 or 11 digit mobile number</span>
              </div>
              <div class="form-group">
                <label for="wrcEmail">Email Address <span class="req">*</span></label>
                <input type="email" id="wrcEmail" name="wrcEmail" required aria-required="true" placeholder="your.email@example.com">
                <span class="help-text">Required for status notifications</span>
              </div>
            </div>
            <div class="form-row-2">
              <div class="form-group">
                <label for="munCity">Municipality/City <span class="req">*</span></label>
                <input type="text" id="munCity" name="munCity" placeholder="e.g., Quezon City" required aria-required="true">
              </div>
              <div class="form-group">
                <label for="province">Province <span class="req">*</span></label>
                <select id="province" name="province" required aria-required="true">
                  <option value="">Select Province</option>
                </select>
                <span class="help-text">Loaded dynamically from server</span>
              </div>
            </div>
            <div class="form-row-full">
              <div class="form-group">
                <label for="customerAddress">Zone/Purok/Sitio/Brgy Address <span class="req">*</span></label>
                <input type="text" id="customerAddress" name="customerAddress" placeholder="Complete address" required aria-required="true">
              </div>
            </div>
          </div>

          <!-- Purchase & Dealer Information -->
          <div class="form-section">
            <h3 class="section-title">Purchase & Dealer Information</h3>
            <div class="form-row-2">
              <div class="form-group">
                <label for="datePurchased">Date Purchased <span class="req">*</span></label>
                <input type="date" id="datePurchased" name="datePurchased" required aria-required="true">
              </div>
              <div class="form-group">
                <label for="wrcDealerCode">Dealer Code <span class="req">*</span></label>
                <select id="wrcDealerCode" name="wrcDealerCode" required aria-required="true" onchange="updateDealerNameDisplay()">
                  <option value="">Select Dealer Code</option>
                  <option value="20052">20052 - GIANT MOTO-BACAYAN</option>
                  <option value="20053">20053 - GIANT MOTO-BARILI</option>
                  <option value="20054">20054 - GIANT MOTO-CARMEN</option>
                  <option value="20055">20055 - GIANT MOTO-CLARIN</option>
                  <option value="20056">20056 - GIANT MOTO-CORDOVA</option>
                  <option value="20051">20051 - GIANT MOTO-LAPULAPU</option>
                  <option value="20057">20057 - GIANT MOTO-MINGLANILLA</option>
                  <option value="20058">20058 - GIANT MOTO-SAN FERNANDO CEBU</option>
                  <option value="20551">20551 - GIANT MOTO-TALISAY</option>
                  <option value="20059">20059 - GIANT MOTO-TOLEDO</option>
                  <option value="20060">20060 - GIANT MOTO-UBAY</option>
                  <option value="20061">20061 - GIANT MOTO-V.RAMA</option>
                </select>
              </div>
            </div>
            <div class="form-row-full">
              <div class="form-group">
                <label for="wrcDealerNameDisplay">Dealer Name <span class="hint">(auto-filled)</span></label>
                <input type="text" id="wrcDealerNameDisplay" name="wrcDealerNameDisplay" placeholder="Select dealer code above" disabled readonly style="background-color: var(--color-bg-alt); color: var(--color-text-light);">
                <span class="help-text">Automatically filled based on selected Dealer Code</span>
              </div>
            </div>
          </div>

          <!-- File Attachment -->
          <div class="form-section">
            <h3 class="section-title">Attach Document or Image</h3>
            <div class="file-upload-section">
              <div class="file-input-wrapper">
                <label for="wrcFileInput" class="file-input-label">
                  <span>Choose File <span class="req">*</span></span>
                </label>
                <input type="file" id="wrcFileInput" name="wrcFileInput" accept="image/*,.pdf,.doc,.docx" onchange="handleFileSelect(event, 'wrc')" aria-label="Upload file for WRC" required aria-required="true">
              </div>
              <div id="wrcFileInfo" class="file-info" style="display:none;"></div>
              <div id="wrcImagePreview" class="image-preview" style="display:none;"></div>
              <div id="wrcUploadProgress" class="upload-progress"></div>
              <p class="file-restrictions">Accepted: Images (JPG, PNG), PDF, Word documents. Max size: 10 MB</p>
              <p class="file-required-note"><strong>Required:</strong> Please attach a document or image before submitting.</p>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="wrcSubmitBtn">Submit WRC Registration</button>
            <button type="button" class="btn btn-secondary" onclick="resetWRCForm()">Reset Form</button>
          </div>
        </form>
      </div>

      <!-- ============================================================
           FSC FORM - Free Service Coupon
           ============================================================ -->
      <div id="panel-fsc" class="form-panel" role="tabpanel" aria-labelledby="tab-fsc">
        <div id="fscMessage" class="message" role="alert"></div>
        <div id="fscValidationBanner" class="validation-banner" role="alert"></div>

        <h2 class="form-title">Free Service Coupon (FSC)</h2>

        <form id="fscForm" onsubmit="submitFSCForm(event)">

          <!-- Branch (FIRST) -->
          <div class="form-section">
            <div class="form-row-full">
              <div class="form-group">
                <label for="fscBranch">Branch <span class="req">*</span></label>
                <select id="fscBranch" name="fscBranch" required aria-required="true">
                  <option value="">Select Branch</option>
                  <option value="BACAYAN">GMPC Bacayan</option>
                  <option value="Balamban">Gmpc Balamban</option>
                  <option value="Barili">Gmpc Barili</option>
                  <option value="Bogo">Gmpc Bogo</option>
                  <option value="Bulacao">Gmpc Bulacao</option>
                  <option value="Camotes">Gmpc Camotes</option>
                  <option value="Candijay">Gmpc Candijay</option>
                  <option value="Carmen">Gmpc Carmen</option>
                  <option value="Clarin">Gmpc Clarin</option>
                  <option value="Consolacion">Gmpc Consolacion</option>
                  <option value="Cordova">Gmpc Cordova</option>
                  <option value="Lagtang">Gmpc Lagtang</option>
                  <option value="Lapu-lapu">Gmpc Lapu-Lapu</option>
                  <option value="Liloan">Gmpc Liloan</option>
                  <option value="Pinamungajan">Gmpc Pinamungajan</option>
                  <option value="Pitogo">Gmpc Pitogo</option>
                  <option value="San Fernando">Gmpc San Fernando</option>
                  <option value="Sierra Bullones">Gmpc Sierra Bullones</option>
                  <option value="Talibon">Gmpc Talibon</option>
                  <option value="Toledo">Gmpc Toledo</option>
                  <option value="Tubigon">Gmpc Tubigon</option>
                  <option value="Ubay">Gmpc Ubay</option>
                  <option value="V Rama">Gmpc V Rama</option>
                  <option value="Yati">Gmpc Yati</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Dealer Information -->
          <div class="form-section">
            <h3 class="section-title">Dealer Information</h3>
            <div class="form-row-2">
              <div class="form-group">
                <label for="fscDealerTransNo">Dealer Transmittal Number <span class="req">*</span>
                  <br>
                  <small style="color: #6b7280; font-weight: normal;">(Auto-generated - Read Only)</small>
                </label>
                <input type="text" id="fscDealerTransNo" name="fscDealerTransNo" readonly required aria-required="true" placeholder="Loading..." style="background-color: var(--color-disabled); cursor: not-allowed;">
              </div>
              <div class="form-group">
                <label for="fscDealerCode">Dealer/Mechanic Code <span class="req">*</span></label>
                <select id="fscDealerCode" name="fscDealerCode" required aria-required="true">
                  <option value="">Select Dealer Code</option>
                  <option value="20052">20052 - GIANT MOTO-BACAYAN</option>
                  <option value="20053">20053 - GIANT MOTO-BARILI</option>
                  <option value="20054">20054 - GIANT MOTO-CARMEN</option>
                  <option value="20055">20055 - GIANT MOTO-CLARIN</option>
                  <option value="20056">20056 - GIANT MOTO-CORDOVA</option>
                  <option value="20051">20051 - GIANT MOTO-LAPULAPU</option>
                  <option value="20057">20057 - GIANT MOTO-MINGLANILLA</option>
                  <option value="20058">20058 - GIANT MOTO-SAN FERNANDO CEBU</option>
                  <option value="20551">20551 - GIANT MOTO-TALISAY</option>
                  <option value="20059">20059 - GIANT MOTO-TOLEDO</option>
                  <option value="20060">20060 - GIANT MOTO-UBAY</option>
                  <option value="20061">20061 - GIANT MOTO-V.RAMA</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Vehicle & Service Information -->
          <div class="form-section">
            <h3 class="section-title">Vehicle & Service Information</h3>
            <div class="form-row-2">
              <div class="form-group">
                <label for="fscWrcNumber">WRC Number <span class="req">*</span></label>
                <input type="text" id="fscWrcNumber" name="fscWrcNumber" required aria-required="true" placeholder="Reference WRC number">
                <span class="help-text">Must match existing WRC record</span>
              </div>
              <div class="form-group">
                <label for="frameNumber">Frame Number <span class="req">*</span></label>
                <input type="text" id="frameNumber" name="frameNumber" required aria-required="true" placeholder="Vehicle frame number">
              </div>
            </div>
            <div class="form-row-2">
              <div class="form-group">
                <label for="couponNumber">Coupon Number <span class="req">*</span></label>
                <select id="couponNumber" name="couponNumber" required aria-required="true">
                  <option value="">Select Coupon Number</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                </select>
              </div>
              <div class="form-group">
                <label for="actualMileage">Actual Mileage <span class="req">*</span></label>
                <input type="number" id="actualMileage" name="actualMileage" required aria-required="true" min="0" step="1" placeholder="0" oninput="enforceWholeNumber(this)">
                <span class="help-text">Whole numbers only, no decimals</span>
              </div>
            </div>
          </div>

          <!-- Repair Information -->
          <div class="form-section">
            <h3 class="section-title">Repair Information</h3>
            <div class="form-row-full">
              <div class="form-group">
                <label for="repairedDate">Repaired Date <span class="req">*</span></label>
                <input type="date" id="repairedDate" name="repairedDate" required aria-required="true">
                <span class="help-text">Split into Month/Day/Year columns</span>
              </div>
            </div>
          </div>

          <!-- Contact Information -->
          <div class="form-section">
            <h3 class="section-title">Contact Information</h3>
            <div class="form-row-full">
              <div class="form-group">
                <label for="fscEmail">Email Address <span class="req">*</span></label>
                <input type="email" id="fscEmail" name="fscEmail" required aria-required="true" placeholder="your.email@example.com">
                <span class="help-text">Required for status notifications</span>
              </div>
            </div>
          </div>

          <!-- File Attachment -->
          <div class="form-section">
            <h3 class="section-title">Attach Document or Image</h3>
            <div class="file-upload-section">
              <div class="file-input-wrapper">
                <label for="fscFileInput" class="file-input-label">
                  <span>Choose File <span class="req">*</span></span>
                </label>
                <input type="file" id="fscFileInput" name="fscFileInput" accept="image/*,.pdf,.doc,.docx" onchange="handleFileSelect(event, 'fsc')" aria-label="Upload file for FSC" required aria-required="true">
              </div>
              <div id="fscFileInfo" class="file-info" style="display:none;"></div>
              <div id="fscImagePreview" class="image-preview" style="display:none;"></div>
              <div id="fscUploadProgress" class="upload-progress"></div>
              <p class="file-restrictions">Accepted: Images (JPG, PNG), PDF, Word documents. Max size: 10 MB</p>
              <p class="file-required-note"><strong>Required:</strong> Please attach a document or image before submitting.</p>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="fscSubmitBtn">Submit FSC Entry</button>
            <button type="button" class="btn btn-secondary" onclick="resetFSCForm()">Reset Form</button>
          </div>
        </form>
      </div>

      <!-- ============================================================
           WLP FORM - Warranty Labor Payment
           ============================================================ -->
      <div id="panel-wlp" class="form-panel" role="tabpanel" aria-labelledby="tab-wlp">
        <div id="wlpMessage" class="message" role="alert"></div>
        <div id="wlpValidationBanner" class="validation-banner" role="alert"></div>

        <h2 class="form-title">Warranty Labor Payment (WLP)</h2>

        <form id="wlpForm" onsubmit="submitWLPForm(event)">

          <!-- Branch (FIRST) -->
          <div class="form-section">
            <div class="form-row-full">
              <div class="form-group">
                <label for="wlpBranch">Branch <span class="req">*</span></label>
                <select id="wlpBranch" name="wlpBranch" required aria-required="true">
                  <option value="">Select Branch</option>
                  <option value="BACAYAN">GMPC Bacayan</option>
                  <option value="Balamban">Gmpc Balamban</option>
                  <option value="Barili">Gmpc Barili</option>
                  <option value="Bogo">Gmpc Bogo</option>
                  <option value="Bulacao">Gmpc Bulacao</option>
                  <option value="Camotes">Gmpc Camotes</option>
                  <option value="Candijay">Gmpc Candijay</option>
                  <option value="Carmen">Gmpc Carmen</option>
                  <option value="Clarin">Gmpc Clarin</option>
                  <option value="Consolacion">Gmpc Consolacion</option>
                  <option value="Cordova">Gmpc Cordova</option>
                  <option value="Lagtang">Gmpc Lagtang</option>
                  <option value="Lapu-lapu">Gmpc Lapu-Lapu</option>
                  <option value="Liloan">Gmpc Liloan</option>
                  <option value="Pinamungajan">Gmpc Pinamungajan</option>
                  <option value="Pitogo">Gmpc Pitogo</option>
                  <option value="San Fernando">Gmpc San Fernando</option>
                  <option value="Sierra Bullones">Gmpc Sierra Bullones</option>
                  <option value="Talibon">Gmpc Talibon</option>
                  <option value="Toledo">Gmpc Toledo</option>
                  <option value="Tubigon">Gmpc Tubigon</option>
                  <option value="Ubay">Gmpc Ubay</option>
                  <option value="V Rama">Gmpc V Rama</option>
                  <option value="Yati">Gmpc Yati</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Service Information -->
          <div class="form-section">
            <h3 class="section-title">Service Information</h3>
            <div class="form-row-full">
              <div class="form-group">
                <label for="wrsNumber">WRS Number <span class="req">*</span></label>
                <input type="text" id="wrsNumber" name="wrsNumber" required aria-required="true" placeholder="Enter WRS number">
              </div>
            </div>
            <div class="form-row-full">
              <div class="form-group">
                <label for="repairAckDate">Repair Acknowledged Date <span class="req">*</span></label>
                <input type="date" id="repairAckDate" name="repairAckDate" required aria-required="true">
                <span class="help-text">Split into Month/Day/Year columns</span>
              </div>
            </div>
          </div>

          <!-- Acknowledgment Information -->
          <div class="form-section">
            <h3 class="section-title">Acknowledgment Information</h3>
            <div class="form-row-full">
              <div class="form-group">
                <label for="acknowledgedBy">Acknowledged By (Customer Name) <span class="req">*</span></label>
                <input type="text" id="acknowledgedBy" name="acknowledgedBy" required aria-required="true" placeholder="Full customer name">
              </div>
            </div>
          </div>

          <!-- Contact Information -->
          <div class="form-section">
            <h3 class="section-title">Email Contact Information</h3>
            <div class="form-row-full">
              <div class="form-group">
                <label for="wlpEmail">Branch Email Address <span class="req">*</span></label>
                <input type="email" id="wlpEmail" name="wlpEmail" required aria-required="true" placeholder="branch.email@gmpc.com.ph">
                <span class="help-text" style="color:var(--color-warning);font-weight:500;"><strong>Note:</strong> Please use the branch email address (not a personal email).</span>
              </div>
            </div>
          </div>

          <!-- Photo Attachments -->
          <div class="form-section">
            <h3 class="section-title">Required Photo Attachments</h3>
            
            <!-- WLP Photo Upload Status (Professional Design) -->
            <div id="wlpPhotoDiagnostics" style="background:#f8fafc;border:1px solid #d0d7de;border-radius:8px;padding:16px;margin-bottom:20px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;display:none">
              <div style="font-size:13px;font-weight:600;color:#24292f;margin-bottom:12px;letter-spacing:0.01em">Upload Status</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:13px">
                <div style="display:flex;align-items:center;gap:8px">
                  <span style="color:#57606a;font-weight:500">Parts Tag:</span>
                  <span id="diagPartsTagBadge" class="wlp-status-badge" data-status="empty">Not selected</span>
                </div>
                <div style="display:flex;align-items:center;gap:8px">
                  <span style="color:#57606a;font-weight:500">Damaged Part:</span>
                  <span id="diagDamagedPartBadge" class="wlp-status-badge" data-status="empty">Not selected</span>
                </div>
              </div>
            </div>
            
            <style>
              .wlp-status-badge {
                display:inline-block;
                padding:3px 10px;
                border-radius:12px;
                font-size:12px;
                font-weight:600;
                line-height:1.4;
                white-space:nowrap;
              }
              .wlp-status-badge[data-status="empty"] {
                background:#f6f8fa;
                color:#57606a;
                border:1px solid #d0d7de;
              }
              .wlp-status-badge[data-status="selected"] {
                background:#ddf4ff;
                color:#0969da;
                border:1px solid #54aeff;
              }
              .wlp-status-badge[data-status="uploaded"] {
                background:#dafbe1;
                color:#1a7f37;
                border:1px solid #4ac26b;
              }
              .wlp-status-badge[data-status="error"] {
                background:#ffebe9;
                color:#cf222e;
                border:1px solid #ff8182;
              }
            </style>
            
            <!-- Parts Tag Photo -->
            <div class="form-row-full" style="margin-bottom: 24px;">
              <div class="form-group">
                <label for="wlpPartsTagInput">Parts Tag Photo <span class="req">*</span> <span class="hint">(1 photo required)</span></label>
                <div class="file-upload-section">
                  <div class="file-input-wrapper">
                    <label for="wlpPartsTagInput" class="file-input-label">
                      <span>Choose Parts Tag Photo <span class="req">*</span></span>
                    </label>
                    <input type="file" id="wlpPartsTagInput" name="wlpPartsTagInput" accept="image/*" onchange="handleWlpMultiFileSelect(event, 'partsTag')" aria-label="Upload parts tag photo for WLP">
                  </div>
                  <div id="wlpPartsTagInfo" class="file-info" style="display:none;"></div>
                  <div id="wlpPartsTagPreview" class="image-preview" style="display:none;"></div>
                  <p class="file-restrictions">Accepted: Images (JPG, PNG) only. Max size: 10 MB per photo.</p>
                </div>
              </div>
            </div>

            <!-- Damaged Part Photos -->
            <div class="form-row-full">
              <div class="form-group">
                <label for="wlpDamagedPartInput">Damaged Part Photos <span class="req">*</span> <span class="hint">(minimum 2 photos required)</span></label>
                <div class="file-upload-section">
                  <div class="file-input-wrapper">
                    <label for="wlpDamagedPartInput" class="file-input-label">
                      <span>Choose Damaged Part Photos <span class="req">*</span></span>
                    </label>
                    <input type="file" id="wlpDamagedPartInput" name="wlpDamagedPartInput" accept="image/*" multiple onchange="handleWlpMultiFileSelect(event, 'damagedPart')" aria-label="Upload damaged part photos for WLP">
                  </div>
                  <div id="wlpDamagedPartInfo" class="file-info" style="display:none;"></div>
                  <div id="wlpDamagedPartPreviews" class="image-preview" style="display:none;"></div>
                  <p class="file-restrictions">Accepted: Images (JPG, PNG) only. Select at least 2 photos. Max size: 10 MB per photo.</p>
                  <p class="file-required-note"><strong>Required:</strong> You must attach at least 2 photos of the damaged part(s).</p>
                </div>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="wlpSubmitBtn">Submit WLP Acknowledgment</button>
            <button type="button" class="btn btn-secondary" onclick="resetWLPForm()">Reset Form</button>
          </div>
        </form>
      </div>

      <!-- ============================================================
           WCF FORM - Warranty Claim Form
           ============================================================ -->
      <div id="panel-wcf" class="form-panel" role="tabpanel" aria-labelledby="tab-wcf">
        <div id="wcfMessage" class="message" role="alert"></div>
        <div id="wcfValidationBanner" class="validation-banner" role="alert"></div>

        <h2 class="form-title">Warranty Claim Form (WCF)</h2>

        <form id="wcfForm" onsubmit="submitWCFForm(event)">

          <!-- Branch (FIRST) -->
          <div class="form-section">
            <div class="form-row-full">
              <div class="form-group">
                <label for="wcfBranch">Branch <span class="req">*</span></label>
                <select id="wcfBranch" name="wcfBranch" required aria-required="true">
                  <option value="">Select Branch</option>
                  <option value="BACAYAN">GMPC Bacayan</option>
                  <option value="Balamban">Gmpc Balamban</option>
                  <option value="Barili">Gmpc Barili</option>
                  <option value="Bogo">Gmpc Bogo</option>
                  <option value="Bulacao">Gmpc Bulacao</option>
                  <option value="Camotes">Gmpc Camotes</option>
                  <option value="Candijay">Gmpc Candijay</option>
                  <option value="Carmen">Gmpc Carmen</option>
                  <option value="Clarin">Gmpc Clarin</option>
                  <option value="Consolacion">Gmpc Consolacion</option>
                  <option value="Cordova">Gmpc Cordova</option>
                  <option value="Lagtang">Gmpc Lagtang</option>
                  <option value="Lapu-lapu">Gmpc Lapu-Lapu</option>
                  <option value="Liloan">Gmpc Liloan</option>
                  <option value="Pinamungajan">Gmpc Pinamungajan</option>
                  <option value="Pitogo">Gmpc Pitogo</option>
                  <option value="San Fernando">Gmpc San Fernando</option>
                  <option value="Sierra Bullones">Gmpc Sierra Bullones</option>
                  <option value="Talibon">Gmpc Talibon</option>
                  <option value="Toledo">Gmpc Toledo</option>
                  <option value="Tubigon">Gmpc Tubigon</option>
                  <option value="Ubay">Gmpc Ubay</option>
                  <option value="V Rama">Gmpc V Rama</option>
                  <option value="Yati">Gmpc Yati</option>
                </select>
              </div>
            </div>
          </div>

          <!-- General Information -->
          <div class="form-section">
            <h3 class="section-title">General Information</h3>
            <div class="form-row-2">
              <div class="form-group">
                <label for="wcfPreparedDate">Prepared Date <span class="req">*</span></label>
                <input type="date" id="wcfPreparedDate" name="wcfPreparedDate" required aria-required="true">
              </div>
              <div class="form-group">
                <label for="wcfJobOrderNo">Job Order No. <span class="req">*</span></label>
                <input type="text" id="wcfJobOrderNo" name="wcfJobOrderNo" placeholder="Job order number" required aria-required="true">
              </div>
            </div>
          </div>

          <!-- Dealer Information -->
          <div class="form-section">
            <h3 class="section-title">Dealer Information</h3>
            <div class="form-row-2">
              <div class="form-group">
                <label for="wcfDealerName">Dealer's Name <span class="req">*</span></label>
                <input type="text" id="wcfDealerName" name="wcfDealerName" required aria-required="true" placeholder="Dealer name" value="GIANT MOTO PRO CORP.">
              </div>
              <div class="form-group">
                <label for="wcfDealerPhone">Phone Number <span class="req">*</span></label>
                <input type="tel" id="wcfDealerPhone" name="wcfDealerPhone" placeholder="Dealer phone number" required aria-required="true">
              </div>
            </div>
            <div class="form-row-full">
              <div class="form-group">
                <label for="wcfDealerAddress">Dealer's Address <span class="req">*</span></label>
                <input type="text" id="wcfDealerAddress" name="wcfDealerAddress" placeholder="Dealer address" required aria-required="true">
              </div>
            </div>
          </div>

          <!-- Customer Information -->
          <div class="form-section">
            <h3 class="section-title">Customer Information</h3>
            <div class="form-row-2">
              <div class="form-group">
                <label for="wcfCustomerName">Customer's Name <span class="req">*</span></label>
                <input type="text" id="wcfCustomerName" name="wcfCustomerName" required aria-required="true" placeholder="Customer full name">
              </div>
              <div class="form-group">
                <label for="wcfCustomerPhone">Phone Number <span class="req">*</span></label>
                <input type="tel" id="wcfCustomerPhone" name="wcfCustomerPhone" placeholder="Customer phone number" required aria-required="true">
              </div>
            </div>
            <div class="form-row-full">
              <div class="form-group">
                <label for="wcfCustomerAddress">Customer's Address <span class="req">*</span></label>
                <input type="text" id="wcfCustomerAddress" name="wcfCustomerAddress" placeholder="Customer address" required aria-required="true">
              </div>
            </div>
          </div>

          <!-- Unit Information -->
          <div class="form-section">
            <h3 class="section-title">Unit Information</h3>
            <div class="form-row-2">
              <div class="form-group">
                <label for="wcfModel">Model <span class="req">*</span></label>
                <input type="text" id="wcfModel" name="wcfModel" required aria-required="true" placeholder="Motorcycle model">
              </div>
              <div class="form-group">
                <label for="wcfColor">Color <span class="req">*</span></label>
                <input type="text" id="wcfColor" name="wcfColor" placeholder="Unit color" required aria-required="true">
              </div>
            </div>
            <div class="form-row-2">
              <div class="form-group">
                <label for="wcfFrameNo">Frame No. <span class="req">*</span></label>
                <input type="text" id="wcfFrameNo" name="wcfFrameNo" required aria-required="true" placeholder="Frame / chassis number">
              </div>
              <div class="form-group">
                <label for="wcfEngineNo">Engine No. <span class="req">*</span></label>
                <input type="text" id="wcfEngineNo" name="wcfEngineNo" required aria-required="true" placeholder="Engine number">
              </div>
            </div>
            <div class="form-row-2">
              <div class="form-group">
                <label for="wcfWrcNo">WRC No. <span class="req">*</span></label>
                <input type="text" id="wcfWrcNo" name="wcfWrcNo" required aria-required="true" placeholder="WRC number">
              </div>
              <div class="form-group">
                <label for="wcfKilometerRun">Kilometer Run <span class="req">*</span></label>
                <input type="number" id="wcfKilometerRun" name="wcfKilometerRun" min="0" placeholder="0" required aria-required="true">
              </div>
            </div>
          </div>

          <!-- Important Dates -->
          <div class="form-section">
            <h3 class="section-title">Important Dates</h3>
            <div class="form-row-2">
              <div class="form-group">
                <label for="wcfPurchaseDate">Purchase Date <span class="req">*</span></label>
                <input type="date" id="wcfPurchaseDate" name="wcfPurchaseDate" required aria-required="true">
              </div>
              <div class="form-group">
                <label for="wcfFailureDate">Failure Date <span class="req">*</span></label>
                <input type="date" id="wcfFailureDate" name="wcfFailureDate" required aria-required="true">
              </div>
            </div>
            <div class="form-row-2">
              <div class="form-group">
                <label for="wcfReportedDate">Reported Date <span class="req">*</span></label>
                <input type="date" id="wcfReportedDate" name="wcfReportedDate" required aria-required="true">
              </div>
              <div class="form-group">
                <label for="wcfRepairDate">Repair Date <span class="req">*</span></label>
                <input type="date" id="wcfRepairDate" name="wcfRepairDate" required aria-required="true">
              </div>
            </div>
          </div>

          <!-- MC Usage -->
          <div class="form-section">
            <h3 class="section-title">Motorcycle Usage</h3>
            <div class="form-row-full">
              <div class="form-group">
                <label>MC Usage <span class="req">*</span></label>
                <div class="radio-group">
                  <label class="radio-label"><input type="radio" name="wcfMcUsage" value="SOLO" required> SOLO</label>
                  <label class="radio-label"><input type="radio" name="wcfMcUsage" value="Tricycle" required> Tricycle</label>
                  <label class="radio-label"><input type="radio" name="wcfMcUsage" value="Others" required> Others</label>
                </div>
                <input type="text" id="wcfMcUsageOther" name="wcfMcUsageOther" placeholder="Specify other usage" style="display:none; margin-top:8px;">
              </div>
            </div>
          </div>

          <!-- Technical Assessment (AD) -->
          <div class="form-section">
            <h3 class="section-title">Technical Assessment</h3>
            <div class="form-row-full">
              <div class="form-group">
                <label for="wcfProblemComplaint">(A) Problem / Complaint Reported by Customer <span class="req">*</span></label>
                <textarea id="wcfProblemComplaint" name="wcfProblemComplaint" rows="3" required aria-required="true" placeholder="Describe the problem or complaint reported by the customer..."></textarea>
              </div>
            </div>
            <div class="form-row-full">
              <div class="form-group">
                <label for="wcfProbableCause">(B) Probable Cause of the Problem Evaluated by KSN <span class="req">*</span></label>
                <textarea id="wcfProbableCause" name="wcfProbableCause" rows="3" placeholder="Probable cause evaluation..." required aria-required="true"></textarea>
              </div>
            </div>
            <div class="form-row-full">
              <div class="form-group">
                <label for="wcfCorrectiveAction">(C) Corrective Action from KSN <span class="req">*</span></label>
                <textarea id="wcfCorrectiveAction" name="wcfCorrectiveAction" rows="3" placeholder="Corrective action taken..." required aria-required="true"></textarea>
              </div>
            </div>
            <div class="form-row-full">
              <div class="form-group">
                <label for="wcfSuggestionRemarks">(D) Suggestion for Improvement / Remarks by KSN <span class="req">*</span></label>
                <textarea id="wcfSuggestionRemarks" name="wcfSuggestionRemarks" rows="3" placeholder="Suggestions or remarks..." required aria-required="true"></textarea>
              </div>
            </div>
          </div>

          <!-- Parts Recommended for Replacement -->
          <div class="form-section">
            <h3 class="section-title">Parts Recommended for Replacement</h3>
            <p style="font-size:0.9rem;color:var(--color-text-light);margin-bottom:12px">Causal Part / Main Defective Part</p>
            <div class="form-row-3">
              <div class="form-group">
                <label for="wcfCausalPartNo">Part No. <span class="req">*</span></label>
                <input type="text" id="wcfCausalPartNo" name="wcfCausalPartNo" placeholder="Part number" required aria-required="true">
              </div>
              <div class="form-group">
                <label for="wcfCausalPartName">Part Name <span class="req">*</span></label>
                <input type="text" id="wcfCausalPartName" name="wcfCausalPartName" placeholder="Part name" required aria-required="true">
              </div>
              <div class="form-group">
                <label for="wcfCausalPartQty">Qty <span class="req">*</span></label>
                <input type="number" id="wcfCausalPartQty" name="wcfCausalPartQty" min="0" placeholder="0" required aria-required="true">
              </div>
            </div>

            <div class="form-row-full">
              <div class="form-group">
                <label>Part Supply Method <span class="req">*</span></label>
                <div class="checkbox-group">
                  <label class="checkbox-label"><input type="checkbox" name="wcfPartSupply" value="KMPC H.O." required> Part to be sent by KMPC H.O.</label>
                  <label class="checkbox-label"><input type="checkbox" name="wcfPartSupply" value="KSC"> Part to be served by KSC</label>
                  <label class="checkbox-label"><input type="checkbox" name="wcfPartSupply" value="SP Dealer"> Buy parts from SP Dealer</label>
                  <label class="checkbox-label"><input type="checkbox" name="wcfPartSupply" value="Use Stock"> Use stock for warranty</label>
                </div>
              </div>
            </div>

            <p style="font-size:0.9rem;font-weight:600;color:var(--color-secondary);margin:20px 0 12px">Affected Parts</p>
            <table class="parts-table" id="affectedPartsTable" style="width:100%;">
              <thead>
                <tr>
                  <th style="width:20%">Part No.</th>
                  <th style="width:30%">Part Name</th>
                  <th style="width:8%">Qty</th>
                  <th style="width:38%">Part Supply Method</th>
                  <th style="width:4%"></th>
                </tr>
              </thead>
              <tbody id="affectedPartsBody">
                <tr>
                  <td><input type="text" class="part-no" placeholder="Part No."></td>
                  <td><input type="text" class="part-name" placeholder="Part Name"></td>
                  <td><input type="number" class="part-qty" min="0" placeholder="0"></td>
                  <td>
                    <div class="checkbox-group" style="display:flex;flex-wrap:wrap;gap:4px;font-size:0.75rem;">
                      <label class="checkbox-label" style="margin:0;white-space:nowrap;"><input type="checkbox" class="supply-kmpc" value="KMPC H.O."> KMPC H.O.</label>
                      <label class="checkbox-label" style="margin:0;white-space:nowrap;"><input type="checkbox" class="supply-ksc" value="KSC"> KSC</label>
                      <label class="checkbox-label" style="margin:0;white-space:nowrap;"><input type="checkbox" class="supply-dealer" value="SP Dealer"> SP Dealer</label>
                      <label class="checkbox-label" style="margin:0;white-space:nowrap;"><input type="checkbox" class="supply-stock" value="Use Stock"> Warranty Stock</label>
                    </div>
                  </td>
                  <td><button type="button" class="btn-remove-row" onclick="removeAffectedPartRow(this)" title="Remove row">&times;</button></td>
                </tr>
              </tbody>
            </table>
            <button type="button" class="btn btn-secondary" style="font-size:0.85rem;padding:8px 16px" onclick="addAffectedPartRow()">+ Add Affected Part</button>

            <div class="form-row-full" style="margin-top:16px">
              <div class="form-group">
                <label for="wcfUnitsSameProblem">No. of unit with the same problem, if any</label>
                <input type="text" id="wcfUnitsSameProblem" name="wcfUnitsSameProblem" placeholder="Enter count or description">
              </div>
            </div>
          </div>

          <!-- Illustration Image Upload -->
          <div class="form-section">
            <h3 class="section-title">Illustration / Picture Indicating the Problem</h3>
            <div class="file-upload-section">
              <div class="file-input-wrapper">
                <label for="wcfFileInput" class="file-input-label">
                  <span>Choose Image <span class="req">*</span></span>
                </label>
                <input type="file" id="wcfFileInput" name="wcfFileInput" accept="image/*,.pdf" onchange="handleFileSelect(event, 'wcf')" aria-label="Upload illustration image for WCF" required aria-required="true">
              </div>
              <div id="wcfFileInfo" class="file-info" style="display:none;"></div>
              <div id="wcfImagePreview" class="image-preview" style="display:none;"></div>
              <div id="wcfUploadProgress" class="upload-progress"></div>
              <p class="file-restrictions">Accepted: Images (JPG, PNG), PDF. Max size: 10 MB</p>
              <p class="file-required-note"><strong>Required:</strong> Attach an image showing the problem. This will be embedded in the PDF.</p>
            </div>
          </div>

          <!-- Delivery Information -->
          <div class="form-section">
            <h3 class="section-title">Delivery Information</h3>
            <div class="form-row-full">
              <div class="form-group">
                <label for="wcfDeliverTo">Deliver To <span class="req">*</span></label>
                <input type="text" id="wcfDeliverTo" name="wcfDeliverTo" placeholder="Parts delivery destination" required aria-required="true">
              </div>
            </div>
          </div>

          <!-- Signatures / Authorization -->
          <div class="form-section">
            <h3 class="section-title">Signatures / Authorization</h3>
            <div class="form-row-3">
              <div class="form-group">
                <label>Prepared by <span class="req">*</span></label>
                <input type="text" id="wcfPreparedByName" name="wcfPreparedByName" placeholder="Printed name" style="margin-bottom:8px" required aria-required="true">
                <div class="signature-pad-container" style="margin-top:8px">
                  <label style="font-size:0.85rem;color:#666;margin-bottom:4px;display:block">Signature</label>
                  <canvas id="wcfPreparedBySignature" class="signature-canvas" width="250" height="100"></canvas>
                  <button type="button" class="btn-clear-sig" onclick="clearSignature('wcfPreparedBySignature')">Clear</button>
                </div>
              </div>
              <div class="form-group">
                <label>Acknowledged by <span class="hint">(Branch Mgr / Service Mgr)</span> <span class="req">*</span></label>
                <input type="text" id="wcfAcknowledgedByName" name="wcfAcknowledgedByName" placeholder="Printed name" style="margin-bottom:8px" required aria-required="true">
                <div class="signature-pad-container" style="margin-top:8px">
                  <label style="font-size:0.85rem;color:#666;margin-bottom:4px;display:block">Signature</label>
                  <canvas id="wcfAcknowledgedBySignature" class="signature-canvas" width="250" height="100"></canvas>
                  <button type="button" class="btn-clear-sig" onclick="clearSignature('wcfAcknowledgedBySignature')">Clear</button>
                </div>
              </div>
              <div class="form-group">
                <label>Warranty Repair Conducted by <span class="req">*</span></label>
                <input type="text" id="wcfWarrantyRepairName" name="wcfWarrantyRepairName" placeholder="Printed name" style="margin-bottom:8px" required aria-required="true">
                <div class="signature-pad-container" style="margin-top:8px">
                  <label style="font-size:0.85rem;color:#666;margin-bottom:4px;display:block">Signature</label>
                  <canvas id="wcfWarrantyRepairSignature" class="signature-canvas" width="250" height="100"></canvas>
                  <button type="button" class="btn-clear-sig" onclick="clearSignature('wcfWarrantyRepairSignature')">Clear</button>
                </div>
              </div>
            </div>

          <!-- Contact Information -->
          <div class="form-section">
            <h3 class="section-title">Contact Information</h3>
            <div class="form-row-full">
              <div class="form-group">
                <label for="wcfEmail">Email Address <span class="req">*</span></label>
                <input type="email" id="wcfEmail" name="wcfEmail" required aria-required="true" placeholder="your.email@example.com">
                <span class="help-text">Required for status notifications and PDF delivery</span>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="wcfSubmitBtn">Submit WCF &amp; Generate PDF</button>
            <button type="button" class="btn btn-secondary" onclick="resetWCFForm()">Reset Form</button>
          </div>
        </form>

        <!-- PDF Download (shown after successful submission) -->
        <div id="wcfPdfDownload" class="pdf-download-section" style="display:none;">
          <div class="pdf-download-card">
            <span class="pdf-icon">&#128196;</span>
            <div class="pdf-download-info">
              <p class="pdf-download-title">WCF PDF Generated Successfully</p>
              <p class="pdf-download-id" id="wcfPdfId"></p>
            </div>
            <a id="wcfPdfLink" href="#" target="_blank" class="btn btn-primary" style="font-size:0.9rem;padding:10px 20px">Download PDF</a>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script>
    'use strict';

    // File storage per form
    var fileStorage = { 
      wrc: null, 
      fsc: null, 
      wlp: null, 
      wcf: null,
      // WLP multi-photo storage
      wlpPartsTag: null,
      wlpDamagedPart: []
    };

    // WLP UI State Machine (WLP only)
    var wlpState = {
      current: 'idle', // idle | editing | submitting | success | error
      suppressValidation: false,
      validationDebounceTimer: null
    };

    function setWlpState(newState) {
      console.log('[WLP STATE] Transition:', wlpState.current, '->', newState);
      wlpState.current = newState;
      
      // Suppress validation during submitting/success states
      wlpState.suppressValidation = (newState === 'submitting' || newState === 'success');
    }

    // ================================================================
    //  DATE FORMATTING: MMDDYYYY
    // ================================================================

    /**
     * Convert YYYY-MM-DD (from date input) to MMDDYYYY
     */
    function formatDateToMMDDYYYY(dateString) {
      if (!dateString) return '';
      var parts = dateString.split('-'); // [YYYY, MM, DD]
      if (parts.length !== 3) return dateString.replace(/[\/\-]/g, '');
      return parts[1] + parts[2] + parts[0]; // MMDDYYYY
    }

    /**
     * Split date string YYYY-MM-DD into components
     */
    function splitDate(dateString) {
      if (!dateString) return { month: '', day: '', year: '' };
      var parts = dateString.split('-');
      return { year: parts[0], month: parts[1], day: parts[2] };
    }

    // ================================================================
    //  FILE UPLOAD: HANDLING & VALIDATION
    // ================================================================

    var MAX_FILE_SIZE = 10 * 1024 * 1024;
    var ALLOWED_TYPES = [
      'image/jpeg','image/png','image/gif','image/webp',
      'application/pdf','application/msword',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
    ];

    function handleFileSelect(event, formType) {
      var file = event.target.files[0];
      var fileInfoEl = document.getElementById(formType + 'FileInfo');
      var previewEl = document.getElementById(formType + 'ImagePreview');
      if (!file) { clearFileSelection(formType); return; }
      if (file.size > MAX_FILE_SIZE) {
        showMessage(formType + 'Message', 'File too large. Max 10 MB. Selected: ' + (file.size/1024/1024).toFixed(2) + ' MB', true);
        event.target.value = '';
        clearFileSelection(formType);
        return;
      }
      if (ALLOWED_TYPES.indexOf(file.type) === -1) {
        showMessage(formType + 'Message', 'Invalid file type. Select image, PDF, or Word document.', true);
        event.target.value = '';
        clearFileSelection(formType);
        return;
      }
      fileStorage[formType] = file;
      fileInfoEl.innerHTML = '<span class="file-name">' + file.name + '</span>'
        + '<span class="file-size">(' + formatFileSize(file.size) + ')</span>'
        + '<button type="button" class="remove-file-btn" onclick="clearFileSelection(\'' + formType + '\')">Remove</button>';
      fileInfoEl.style.display = 'block';
      if (file.type.startsWith('image/')) {
        var reader = new FileReader();
        reader.onload = function(e) {
          previewEl.innerHTML = '<img src="' + e.target.result + '" alt="Preview">';
          previewEl.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        previewEl.style.display = 'none';
      }
    }

    function clearFileSelection(formType) {
      fileStorage[formType] = null;
      document.getElementById(formType + 'FileInput').value = '';
      document.getElementById(formType + 'FileInfo').style.display = 'none';
      document.getElementById(formType + 'ImagePreview').style.display = 'none';
    }

    // ================================================================
    //  WLP MULTI-FILE UPLOAD: HANDLING & VALIDATION
    // ================================================================

    /**
     * Handle WLP multi-photo file selection (Parts Tag + Damaged Part)
     * @param {Event} event - File input change event
     * @param {string} photoType - 'partsTag' or 'damagedPart'
     */
    function handleWlpMultiFileSelect(event, photoType) {
      var files = Array.from(event.target.files);
      var infoEl = document.getElementById('wlp' + (photoType === 'partsTag' ? 'PartsTag' : 'DamagedPart') + 'Info');
      var previewEl = document.getElementById('wlp' + (photoType === 'partsTag' ? 'PartsTag' : 'DamagedPart') + (photoType === 'partsTag' ? 'Preview' : 'Previews'));
      
      if (!files || files.length === 0) {
        clearWlpFileSelection(photoType);
        return;
      }

      // Validation
      var errors = [];

      // Validate count
      if (photoType === 'partsTag' && files.length !== 1) {
        errors.push('Parts Tag: Please select exactly 1 photo (you selected ' + files.length + ')');
      }
      if (photoType === 'damagedPart' && files.length < 2) {
        errors.push('Damaged Part: Please select at least 2 photos (you selected ' + files.length + ')');
      }

      // Validate each file
      files.forEach(function(file, idx) {
        if (file.size > MAX_FILE_SIZE) {
          errors.push(file.name + ': File too large (' + (file.size/1024/1024).toFixed(2) + ' MB). Max 10 MB per photo.');
        }
        if (!file.type.startsWith('image/')) {
          errors.push(file.name + ': Only image files are accepted.');
        }
      });

      if (errors.length > 0) {
        showMessage('wlpMessage', '<strong>Photo upload error:</strong><ul style="margin:8px 0;padding-left:20px">' 
          + errors.map(function(e) { return '<li>' + e + '</li>'; }).join('') + '</ul>', true);
        event.target.value = '';
        clearWlpFileSelection(photoType);
        return;
      }

      // Store files
      if (photoType === 'partsTag') {
        fileStorage.wlpPartsTag = files[0];
        console.log('[WLP] Parts Tag photo selected:', files[0].name, files[0].size, 'bytes');
      } else {
        fileStorage.wlpDamagedPart = files;
        console.log('[WLP] Damaged Part photos selected:', files.length, 'files');
        files.forEach(function(f, i) {
          console.log('  [' + (i+1) + ']', f.name, f.size, 'bytes');
        });
      }

      // Update diagnostics display
      updateWlpDiagnostics();

      // Display file info
      var fileList = files.map(function(f) {
        return '<div style="margin:4px 0;padding:4px 8px;background:#f8f9fa;border-radius:4px">'
          + '<span class="file-name">' + f.name + '</span> '
          + '<span class="file-size">(' + formatFileSize(f.size) + ')</span>'
          + '</div>';
      }).join('');

      infoEl.innerHTML = '<div style="margin-bottom:8px"><strong>' + files.length + ' photo' + (files.length > 1 ? 's' : '') + ' selected:</strong></div>' 
        + fileList
        + '<button type="button" class="remove-file-btn" onclick="clearWlpFileSelection(\'' + photoType + '\')" style="margin-top:8px">Remove All</button>';
      infoEl.style.display = 'block';

      // Show previews
      previewEl.innerHTML = '';
      files.forEach(function(file, idx) {
        var reader = new FileReader();
        reader.onload = function(e) {
          var imgDiv = document.createElement('div');
          imgDiv.style.cssText = 'display:inline-block;margin:8px;border:1px solid #ddd;border-radius:4px;overflow:hidden';
          imgDiv.innerHTML = '<img src="' + e.target.result + '" alt="Preview ' + (idx + 1) + '" style="max-width:150px;max-height:150px;display:block">'
            + '<div style="font-size:0.75rem;padding:4px;text-align:center;background:#f8f9fa">' + (idx + 1) + '</div>';
          previewEl.appendChild(imgDiv);
        };
        reader.readAsDataURL(file);
      });
      previewEl.style.display = 'block';
    }

    /**
     * Clear WLP multi-photo selection
     * @param {string} photoType - 'partsTag' or 'damagedPart'
     */
    function clearWlpFileSelection(photoType) {
      if (photoType === 'partsTag') {
        fileStorage.wlpPartsTag = null;
        document.getElementById('wlpPartsTagInput').value = '';
        document.getElementById('wlpPartsTagInfo').style.display = 'none';
        document.getElementById('wlpPartsTagPreview').style.display = 'none';
        console.log('[WLP] Parts Tag cleared');
      } else {
        fileStorage.wlpDamagedPart = [];
        document.getElementById('wlpDamagedPartInput').value = '';
        document.getElementById('wlpDamagedPartInfo').style.display = 'none';
        document.getElementById('wlpDamagedPartPreviews').style.display = 'none';
        console.log('[WLP] Damaged Part cleared');
      }
      updateWlpDiagnostics();
    }

    /**
     * Update WLP photo diagnostics display with professional badge styling
     */
    function updateWlpDiagnostics() {
      // Debounce to prevent flicker
      if (wlpState.validationDebounceTimer) {
        clearTimeout(wlpState.validationDebounceTimer);
      }
      
      wlpState.validationDebounceTimer = setTimeout(function() {
        var diagDiv = document.getElementById('wlpPhotoDiagnostics');
        if (!diagDiv) return;

        var partsTagCount = fileStorage.wlpPartsTag ? 1 : 0;
        var damagedPartCount = fileStorage.wlpDamagedPart ? fileStorage.wlpDamagedPart.length : 0;

        var partsTagBadge = document.getElementById('diagPartsTagBadge');
        var damagedPartBadge = document.getElementById('diagDamagedPartBadge');

        // Update Parts Tag badge
        if (partsTagCount === 1) {
          partsTagBadge.textContent = '1 selected';
          partsTagBadge.setAttribute('data-status', 'selected');
        } else if (wlpState.current === 'error' && partsTagCount === 0) {
          partsTagBadge.textContent = 'Required';
          partsTagBadge.setAttribute('data-status', 'error');
        } else {
          partsTagBadge.textContent = 'Not selected';
          partsTagBadge.setAttribute('data-status', 'empty');
        }

        // Update Damaged Part badge
        if (damagedPartCount >= 2) {
          damagedPartBadge.textContent = damagedPartCount + ' selected';
          damagedPartBadge.setAttribute('data-status', 'selected');
        } else if (wlpState.current === 'error' && damagedPartCount < 2) {
          damagedPartBadge.textContent = damagedPartCount + ' (need 2+)';
          damagedPartBadge.setAttribute('data-status', 'error');
        } else if (damagedPartCount === 1) {
          damagedPartBadge.textContent = '1 selected (need 2+)';
          damagedPartBadge.setAttribute('data-status', 'empty');
        } else {
          damagedPartBadge.textContent = 'Not selected';
          damagedPartBadge.setAttribute('data-status', 'empty');
        }

        // Show diagnostic panel if any files selected OR if in error state
        if (partsTagCount > 0 || damagedPartCount > 0 || wlpState.current === 'error') {
          diagDiv.style.display = 'block';
        } else {
          diagDiv.style.display = 'none';
        }
      }, 250); // 250ms debounce
    }

    /**
     * Upload multiple WLP photos to Google Drive
     * @param {File[]} files - Array of File objects
     * @param {string} photoType - 'partsTag' or 'damagedPart'
     * @param {string} wrsNumber - WRS Number for naming
     * @returns {Promise<Array>} Array of {url, fileId, name} objects
     */
    function uploadWlpPhotos(files, photoType, wrsNumber) {
      return new Promise(function(resolve, reject) {
        var uploadedFiles = [];
        var uploadPromises = [];

        files.forEach(function(file, idx) {
          var promise = new Promise(function(res, rej) {
            var reader = new FileReader();
            reader.onload = function(e) {
              var fileData = {
                name: file.name,
                type: file.type,
                data: e.target.result.split(',')[1],
                formType: 'WLP',
                photoType: photoType,
                photoIndex: idx,
                wrsNumber: wrsNumber
              };
              
              google.script.run
                .withSuccessHandler(function(response) {
                  if (response.success) {
                    res({ url: response.url, fileId: response.fileId, name: file.name });
                  } else {
                    rej(new Error(response.message || 'Upload failed'));
                  }
                })
                .withFailureHandler(function(error) {
                  rej(error);
                })
                .uploadWlpPhoto(fileData);
            };
            reader.onerror = function() {
              rej(new Error('Failed to read file: ' + file.name));
            };
            reader.readAsDataURL(file);
          });
          
          uploadPromises.push(promise);
        });

        Promise.all(uploadPromises)
          .then(function(results) {
            resolve(results);
          })
          .catch(function(error) {
            reject(error);
          });
      });
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      var k = 1024;
      var sizes = ['Bytes','KB','MB'];
      var i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function uploadFile(file, formType) {
      return new Promise(function(resolve, reject) {
        var progressEl = document.getElementById(formType + 'UploadProgress');
        progressEl.textContent = 'Uploading file...';
        progressEl.classList.add('visible');
        var reader = new FileReader();
        reader.onload = function(e) {
          var fileData = {
            name: file.name,
            type: file.type,
            data: e.target.result.split(',')[1],
            formType: formType.toUpperCase()
          };
          google.script.run
            .withSuccessHandler(function(response) {
              progressEl.classList.remove('visible');
              if (response.success) resolve(response.url);
              else reject(new Error(response.message || 'Upload failed'));
            })
            .withFailureHandler(function(error) {
              progressEl.classList.remove('visible');
              reject(error);
            })
            .uploadFile(fileData);
        };
        reader.onerror = function() { progressEl.classList.remove('visible'); reject(new Error('Failed to read file')); };
        reader.readAsDataURL(file);
      });
    }

    // ================================================================
    //  UI: TAB SWITCHING
    // ================================================================

    function switchForm(formType) {
      document.querySelectorAll('.form-panel').forEach(function(p) { p.classList.remove('active'); });
      document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); t.setAttribute('aria-selected','false'); });
      document.getElementById('panel-' + formType).classList.add('active');
      var activeTab = document.getElementById('tab-' + formType);
      activeTab.classList.add('active');
      activeTab.setAttribute('aria-selected','true');
      
      // FSC-only: Load auto-generated transmittal number when tab is activated
      if (formType === 'fsc') {
        loadFscTransmittalNumber();
      }
    }

    // ================================================================
    //  FSC: AUTO-GENERATED TRANSMITTAL NUMBER
    // ================================================================

    /**
     * Fetch and display the next FSC transmittal number (FSC1, FSC2, etc.)
     * This number is auto-generated server-side and read-only in the UI.
     */
    function loadFscTransmittalNumber() {
      var input = document.getElementById('fscDealerTransNo');
      if (!input) return;
      
      // Show loading state
      input.value = 'Loading...';
      input.style.backgroundColor = 'var(--color-disabled)';
      
      google.script.run
        .withSuccessHandler(function(transmittalNo) {
          if (transmittalNo && transmittalNo !== 'FSC-ERROR') {
            input.value = transmittalNo;
            input.style.backgroundColor = 'var(--color-disabled)';
          } else {
            input.value = 'Error loading number';
            input.style.backgroundColor = 'var(--color-error-bg)';
          }
        })
        .withFailureHandler(function(error) {
          input.value = 'Error: ' + error.message;
          input.style.backgroundColor = 'var(--color-error-bg)';
          console.error('Failed to load FSC transmittal number:', error);
        })
        .getFscTransmittalNumberForUI();
    }


    // ================================================================
    //  UI: MESSAGE DISPLAY
    // ================================================================

    function showMessage(elementId, message, isError) {
      var msgEl = document.getElementById(elementId);
      var icon = isError ? '' : '';
      msgEl.innerHTML = '<div class="message-content"><span class="message-icon">' + icon + '</span><span class="message-text">' + message + '</span></div>';
      msgEl.className = 'message visible ' + (isError ? 'error' : 'success');
      msgEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      setTimeout(function() { msgEl.classList.remove('visible'); }, 10000);
    }

    function setButtonLoading(buttonId, isLoading) {
      var btn = document.getElementById(buttonId);
      if (isLoading) {
        btn.disabled = true;
        btn.dataset.originalText = btn.textContent;
        btn.innerHTML = btn.textContent + ' <span class="spinner"></span>';
      } else {
        btn.disabled = false;
        btn.textContent = btn.dataset.originalText || btn.textContent;
      }
    }

    // ================================================================
    //  VALIDATION
    // ================================================================

    function validateForm(formElement, formType) {
      var inputs = formElement.querySelectorAll('input[required], select[required], textarea[required]');
      var missingFields = [];
      var isValid = true;

      // Clear previous errors
      inputs.forEach(function(input) {
        input.classList.remove('field-error');
        var errorMsg = input.parentElement.querySelector('.error-message');
        if (errorMsg) errorMsg.remove();
      });

      // Validate each required field
      inputs.forEach(function(input) {
        var fieldLabel = '';
        var label = input.parentElement.querySelector('label');
        if (label) fieldLabel = label.textContent.replace(/\*/g,'').trim();
        else fieldLabel = input.getAttribute('aria-label') || input.name || 'Unknown';

        var isEmpty = false;
        var errorMessage = 'This field is required';
        
        if (input.type === 'file') {
          // WLP has custom multi-photo validation in submitWLPForm, skip here
          if (formType === 'wlp') {
            return; // Skip file validation for WLP (handled separately)
          }
          isEmpty = !fileStorage[formType];
        } else if (input.type === 'radio') {
          // For radio buttons, check if ANY in the group is checked
          var radioName = input.getAttribute('name');
          var radioGroup = formElement.querySelectorAll('input[name="' + radioName + '"]');
          var anyChecked = false;
          radioGroup.forEach(function(r) { if (r.checked) anyChecked = true; });
          isEmpty = !anyChecked;
          // Only show error once per radio group (on first element)
          if (isEmpty && input === radioGroup[0]) {
            isValid = false;
            input.parentElement.parentElement.classList.add('field-error');
            missingFields.push(fieldLabel);
          }
          return; // Skip individual radio button validation
        } else if (input.type === 'checkbox') {
          // For checkbox groups with required, check if at least one is checked
          var checkboxName = input.getAttribute('name');
          var checkboxGroup = formElement.querySelectorAll('input[name="' + checkboxName + '"]');
          var anyChecked = false;
          checkboxGroup.forEach(function(cb) { if (cb.checked) anyChecked = true; });
          isEmpty = !anyChecked;
          // Only show error once per checkbox group (on first element)
          if (isEmpty && input === checkboxGroup[0]) {
            isValid = false;
            input.parentElement.parentElement.classList.add('field-error');
            missingFields.push(fieldLabel + ' (select at least one)');
          }
          return; // Skip individual checkbox validation
        } else if (input.tagName === 'SELECT') {
          isEmpty = !input.value || input.value === '';
        } else {
          isEmpty = !input.value || input.value.trim() === '';
        }

        // Additional validation for specific field types
        if (!isEmpty && input.type === 'email') {
          var emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailPattern.test(input.value)) {
            isValid = false;
            input.classList.add('field-error');
            missingFields.push(fieldLabel + ' (invalid format)');
            errorMessage = 'Please enter a valid email address';
            var errorSpan = document.createElement('span');
            errorSpan.className = 'error-message';
            errorSpan.textContent = errorMessage;
            errorSpan.setAttribute('role','alert');
            input.parentElement.appendChild(errorSpan);
            isEmpty = false; // Already handled
          }
        }

        if (isEmpty) {
          isValid = false;
          input.classList.add('field-error');
          missingFields.push(fieldLabel);
          if (input.type !== 'file') {
            var errorSpan = document.createElement('span');
            errorSpan.className = 'error-message';
            errorSpan.textContent = errorMessage;
            errorSpan.setAttribute('role','alert');
            input.parentElement.appendChild(errorSpan);
          }
        }
      });

      // WCF-specific: Validate signatures (canvas elements)
      if (formType === 'wcf') {
        var signatureFields = [
          { id: 'wcfPreparedBySignature', label: 'Prepared by Signature' },
          { id: 'wcfAcknowledgedBySignature', label: 'Acknowledged by Signature' },
          { id: 'wcfWarrantyRepairSignature', label: 'Warranty Repair Signature' }
        ];
        
        signatureFields.forEach(function(sig) {
          var pad = signaturePads[sig.id];
          if (pad && pad.isEmpty) {
            isValid = false;
            missingFields.push(sig.label);
            var canvas = document.getElementById(sig.id);
            if (canvas) {
              canvas.parentElement.classList.add('field-error');
              var existingError = canvas.parentElement.querySelector('.error-message');
              if (!existingError) {
                var errorSpan = document.createElement('span');
                errorSpan.className = 'error-message';
                errorSpan.textContent = 'Signature is required';
                errorSpan.setAttribute('role','alert');
                canvas.parentElement.appendChild(errorSpan);
              }
            }
          }
        });
      }

      // Show validation banner if errors exist
      var banner = document.getElementById(formType + 'ValidationBanner');
      if (!isValid && banner) {
        banner.innerHTML = '<h4 class="validation-banner-title">Please complete all required fields</h4>'
          + '<ul class="validation-banner-list">' + missingFields.map(function(f) { return '<li>' + f + '</li>'; }).join('') + '</ul>';
        banner.classList.add('visible');
        banner.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } else if (banner) {
        banner.classList.remove('visible');
      }

      return isValid;
    }

    function validateField(input) {
      input.classList.remove('field-error');
      var errorMsg = input.parentElement.querySelector('.error-message');
      if (errorMsg) errorMsg.remove();
      if (input.hasAttribute('required')) {
        var isEmpty = false;
        var errorMessage = 'This field is required';
        
        if (input.type === 'file') isEmpty = !input.files || input.files.length === 0;
        else if (input.tagName === 'SELECT') isEmpty = !input.value || input.value === '';
        else isEmpty = !input.value || input.value.trim() === '';
        
        // Email validation
        if (!isEmpty && input.type === 'email') {
          var emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailPattern.test(input.value)) {
            input.classList.add('field-error');
            errorMessage = 'Please enter a valid email address';
            var errorSpan = document.createElement('span');
            errorSpan.className = 'error-message';
            errorSpan.textContent = errorMessage;
            input.parentElement.appendChild(errorSpan);
            return;
          }
        }
        
        if (isEmpty && input.type !== 'file') {
          input.classList.add('field-error');
          var errorSpan = document.createElement('span');
          errorSpan.className = 'error-message';
          errorSpan.textContent = errorMessage;
          input.parentElement.appendChild(errorSpan);
        }
      }
    }

    function enforceWholeNumber(input) {
      if (input.value.includes('.')) input.value = Math.floor(parseFloat(input.value));
      if (input.value < 0) input.value = 0;
    }

    // ================================================================
    //  WRC FORM: SUBMISSION
    // ================================================================

    async function submitWRCForm(event) {
      event.preventDefault();
      var form = event.target;
      if (!validateForm(form, 'wrc')) {
        showMessage('wrcMessage', 'Please fill in all required fields before submitting.', true);
        return;
      }
      if (!fileStorage.wrc) {
        showMessage('wrcMessage', 'Please attach a document or image file.', true);
        return;
      }

      setButtonLoading('wrcSubmitBtn', true);
      var fileUrl = '';
      try {
        fileUrl = await uploadFile(fileStorage.wrc, 'wrc');
      } catch (error) {
        setButtonLoading('wrcSubmitBtn', false);
        showMessage('wrcMessage', 'File upload failed: ' + error.message, true);
        return;
      }

      var formData = {
        wrcNo: document.getElementById('wrcNo').value.trim(),
        engineNo: document.getElementById('engineNo').value.trim(),
        firstName: document.getElementById('firstName').value.trim(),
        mi: document.getElementById('mi').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        munCity: document.getElementById('munCity').value.trim(),
        province: document.getElementById('province').value,
        contactNo: document.getElementById('contactNo').value.trim(),
        datePurchased: formatDateToMMDDYYYY(document.getElementById('datePurchased').value),
        // dealerName is auto-derived from dealerCode in backend
        customerAddress: document.getElementById('customerAddress').value.trim(),
        age: document.getElementById('age').value,
        gender: document.getElementById('gender').value,
        dealerCode: document.getElementById('wrcDealerCode').value,
        branch: document.getElementById('wrcBranch').value,
        email: document.getElementById('wrcEmail').value.trim(),
        fileUrl: fileUrl
      };

      google.script.run
        .withSuccessHandler(function(response) {
          setButtonLoading('wrcSubmitBtn', false);
          if (response.success) {
            showMessage('wrcMessage', response.message, false);
            form.reset();
            clearFileSelection('wrc');
          } else {
            // Handle structured validation errors from backend
            if (response.errorType === 'VALIDATION' && response.missingFields && response.missingFields.length > 0) {
              var errorHtml = '<strong>Submission failed. Missing required fields:</strong><ul style="margin-top:8px;padding-left:20px;">';
              response.missingFields.forEach(function(field) {
                errorHtml += '<li>' + field + '</li>';
              });
              errorHtml += '</ul>';
              var msgDiv = document.getElementById('wrcMessage');
              msgDiv.innerHTML = errorHtml;
              msgDiv.className = 'message-box message-error';
              msgDiv.style.display = 'block';
            } else {
              showMessage('wrcMessage', response.message, true);
            }
          }
        })
        .withFailureHandler(function(error) {
          setButtonLoading('wrcSubmitBtn', false);
          showMessage('wrcMessage', 'Server error: ' + error.message, true);
        })
        .submitWRC(formData);
    }

    /**
     * Dealer Code to Dealer Name mapping (WRC auto-fill)
     * This must match the backend DEALER_CODE_MAP in Code.gs
     */
    const DEALER_CODE_MAP = {
      '20052': 'GIANT MOTO-BACAYAN',
      '20053': 'GIANT MOTO-BARILI',
      '20054': 'GIANT MOTO-CARMEN',
      '20055': 'GIANT MOTO-CLARIN',
      '20056': 'GIANT MOTO-CORDOVA',
      '20051': 'GIANT MOTO-LAPULAPU',
      '20057': 'GIANT MOTO-MINGLANILLA',
      '20058': 'GIANT MOTO-SAN FERNANDO CEBU',
      '20551': 'GIANT MOTO-TALISAY',
      '20059': 'GIANT MOTO-TOLEDO',
      '20060': 'GIANT MOTO-UBAY',
      '20061': 'GIANT MOTO-V.RAMA'
    };

    /**
     * Update the dealer name display when dealer code is selected (WRC form)
     */
    function updateDealerNameDisplay() {
      var dealerCode = document.getElementById('wrcDealerCode').value;
      var dealerNameDisplay = document.getElementById('wrcDealerNameDisplay');
      
      if (dealerCode && DEALER_CODE_MAP[dealerCode]) {
        dealerNameDisplay.value = DEALER_CODE_MAP[dealerCode];
      } else {
        dealerNameDisplay.value = '';
      }
    }

    function resetWRCForm() {
      document.getElementById('wrcForm').reset();
      document.getElementById('wrcDealerNameDisplay').value = '';
      clearFileSelection('wrc');
      document.getElementById('wrcMessage').classList.remove('visible');
    }

    // ================================================================
    //  FSC FORM: SUBMISSION
    // ================================================================

    async function submitFSCForm(event) {
      event.preventDefault();
      var form = event.target;
      if (!validateForm(form, 'fsc')) {
        showMessage('fscMessage', 'Please fill in all required fields before submitting.', true);
        return;
      }
      if (!fileStorage.fsc) {
        showMessage('fscMessage', 'Please attach a document or image file.', true);
        return;
      }

      setButtonLoading('fscSubmitBtn', true);
      var fileUrl = '';
      try {
        fileUrl = await uploadFile(fileStorage.fsc, 'fsc');
      } catch (error) {
        setButtonLoading('fscSubmitBtn', false);
        showMessage('fscMessage', 'File upload failed: ' + error.message, true);
        return;
      }

      var repairedDateSplit = splitDate(document.getElementById('repairedDate').value);

      var formData = {
        dealerTransNo: document.getElementById('fscDealerTransNo').value.trim(),
        dealerMechCode: document.getElementById('fscDealerCode').value,
        wrcNumber: document.getElementById('fscWrcNumber').value.trim(),
        frameNumber: document.getElementById('frameNumber').value.trim(),
        couponNumber: document.getElementById('couponNumber').value.trim(),
        actualMileage: document.getElementById('actualMileage').value,
        repairedMonth: repairedDateSplit.month,
        repairedDay: repairedDateSplit.day,
        repairedYear: repairedDateSplit.year,
        // kscCode removed - no longer required
        branch: document.getElementById('fscBranch').value,
        email: document.getElementById('fscEmail').value.trim(),
        fileUrl: fileUrl
      };

      google.script.run
        .withSuccessHandler(function(response) {
          setButtonLoading('fscSubmitBtn', false);
          if (response.success) {
            showMessage('fscMessage', response.message, false);
            form.reset();
            clearFileSelection('fsc');
            // Reload the next transmittal number for the next submission
            loadFscTransmittalNumber();
          } else {
            // Handle structured validation errors from backend
            if (response.errorType === 'VALIDATION' && response.missingFields && response.missingFields.length > 0) {
              var errorHtml = '<strong>Submission failed. Missing required fields:</strong><ul style="margin-top:8px;padding-left:20px;">';
              response.missingFields.forEach(function(field) {
                errorHtml += '<li>' + field + '</li>';
              });
              errorHtml += '</ul>';
              var msgDiv = document.getElementById('fscMessage');
              msgDiv.innerHTML = errorHtml;
              msgDiv.className = 'message-box message-error';
              msgDiv.style.display = 'block';
            } else {
              showMessage('fscMessage', response.message, true);
            }
          }
        })
        .withFailureHandler(function(error) {
          setButtonLoading('fscSubmitBtn', false);
          showMessage('fscMessage', 'Server error: ' + error.message, true);
        })
        .submitFSC(formData);
    }

    function resetFSCForm() {
      document.getElementById('fscForm').reset();
      clearFileSelection('fsc');
      document.getElementById('fscMessage').classList.remove('visible');
    }

    // ================================================================
    //  WLP FORM: SUBMISSION WITH MULTI-PHOTO VALIDATION
    // ================================================================

    async function submitWLPForm(event) {
      event.preventDefault();
      var form = event.target;
      
      // Set state to editing (enables validation)
      setWlpState('editing');
      
      console.log('[WLP SUBMIT] Starting submission process...');
      console.log('[WLP SUBMIT] fileStorage.wlpPartsTag:', fileStorage.wlpPartsTag ? fileStorage.wlpPartsTag.name : 'NULL');
      console.log('[WLP SUBMIT] fileStorage.wlpDamagedPart:', fileStorage.wlpDamagedPart ? fileStorage.wlpDamagedPart.length + ' files' : 'NULL');
      
      // Standard form validation
      if (!validateForm(form, 'wlp')) {
        setWlpState('error');
        updateWlpDiagnostics(); // Update badges to show error state
        showMessage('wlpMessage', 'Please fill in all required fields before submitting.', true);
        return;
      }

      // WLP-specific multi-photo validation
      var validationErrors = [];
      var partsTagCount = fileStorage.wlpPartsTag ? 1 : 0;
      var damagedPartCount = fileStorage.wlpDamagedPart ? fileStorage.wlpDamagedPart.length : 0;
      
      console.log('[WLP VALIDATION] Parts Tag count:', partsTagCount);
      console.log('[WLP VALIDATION] Damaged Part count:', damagedPartCount);
      
      if (partsTagCount !== 1) {
        validationErrors.push('Parts Tag photo is required (exactly 1 photo, you have ' + partsTagCount + ')');
      }
      
      if (damagedPartCount < 2) {
        validationErrors.push('Damaged Part photos: at least 2 required (you have ' + damagedPartCount + ')');
      }

      if (validationErrors.length > 0) {
        console.error('[WLP VALIDATION] Failed:', validationErrors);
        setWlpState('error');
        updateWlpDiagnostics(); // Update badges to show error state
        showMessage('wlpMessage', '<strong>Photo attachment error:</strong><ul style="margin:8px 0;padding-left:20px">' 
          + validationErrors.map(function(e) { return '<li>' + e + '</li>'; }).join('') + '</ul>', true);
        return;
      }

      // Validation passed - enter submitting state
      setWlpState('submitting');
      setButtonLoading('wlpSubmitBtn', true);
      showMessage('wlpMessage', 'Uploading photos... Please wait.', false);

      var wrsNumber = document.getElementById('wrsNumber').value.trim();
      console.log('[WLP UPLOAD] WRS Number:', wrsNumber);

      // Upload Parts Tag photo
      var partsTagResults = [];
      var damagedPartResults = [];

      try {
        console.log('[WLP UPLOAD] Starting Parts Tag upload...');
        partsTagResults = await uploadWlpPhotos([fileStorage.wlpPartsTag], 'partsTag', wrsNumber);
        console.log('[WLP UPLOAD] Parts Tag upload complete:', partsTagResults);
        
        // Update badge to uploaded state
        var partsTagBadge = document.getElementById('diagPartsTagBadge');
        partsTagBadge.textContent = 'Uploaded';
        partsTagBadge.setAttribute('data-status', 'uploaded');
        
        showMessage('wlpMessage', 'Parts Tag uploaded. Uploading Damaged Part photos...', false);
      } catch (error) {
        console.error('[WLP UPLOAD] Parts Tag upload failed:', error);
        setWlpState('error');
        updateWlpDiagnostics();
        setButtonLoading('wlpSubmitBtn', false);
        showMessage('wlpMessage', 'Parts Tag photo upload failed: ' + error.message, true);
        return;
      }

      // Upload Damaged Part photos
      try {
        console.log('[WLP UPLOAD] Starting Damaged Part upload...');
        damagedPartResults = await uploadWlpPhotos(fileStorage.wlpDamagedPart, 'damagedPart', wrsNumber);
        console.log('[WLP UPLOAD] Damaged Part upload complete:', damagedPartResults);
        
        // Update badge to uploaded state
        var damagedPartBadge = document.getElementById('diagDamagedPartBadge');
        damagedPartBadge.textContent = damagedPartResults.length + ' uploaded';
        damagedPartBadge.setAttribute('data-status', 'uploaded');
        
        showMessage('wlpMessage', 'All photos uploaded. Submitting form...', false);
      } catch (error) {
        console.error('[WLP UPLOAD] Damaged Part upload failed:', error);
        setWlpState('error');
        updateWlpDiagnostics();
        setButtonLoading('wlpSubmitBtn', false);
        showMessage('wlpMessage', 'Damaged Part photos upload failed: ' + error.message, true);
        return;
      }

      var ackDateSplit = splitDate(document.getElementById('repairAckDate').value);

      var formData = {
        wrsNumber: wrsNumber,
        repairAckMonth: ackDateSplit.month,
        repairAckDay: ackDateSplit.day,
        repairAckYear: ackDateSplit.year,
        acknowledgedBy: document.getElementById('acknowledgedBy').value.trim(),
        dealerMechCode: '20551',
        branch: document.getElementById('wlpBranch').value,
        email: document.getElementById('wlpEmail').value.trim(),
        // Multi-photo data
        partsTagPhoto: partsTagResults[0], // {url, fileId, name}
        damagedPartPhotos: damagedPartResults // [{url, fileId, name}, ...]
      };

      console.log('[WLP SUBMIT] Payload prepared:');
      console.log('  - Payload keys:', Object.keys(formData).join(', '));
      console.log('  - partsTagPhoto:', formData.partsTagPhoto);
      console.log('  - damagedPartPhotos count:', formData.damagedPartPhotos.length);
      console.log('  - damagedPartPhotos:', formData.damagedPartPhotos);

      console.log('[WLP SUBMIT] Calling server submitWLP...');

      google.script.run
        .withSuccessHandler(function(response) {
          console.log('[WLP SUBMIT] Server response:', response);
          setButtonLoading('wlpSubmitBtn', false);
          if (response.success) {
            // Enter SUCCESS state - suppress validation
            setWlpState('success');
            
            // Show success message and keep it visible
            showMessage('wlpMessage', response.message, false);
            
            // Delay form reset to prevent validation flash
            setTimeout(function() {
              console.log('[WLP SUCCESS] Resetting form after delay...');
              
              // Reset badges to empty state
              var partsTagBadge = document.getElementById('diagPartsTagBadge');
              var damagedPartBadge = document.getElementById('diagDamagedPartBadge');
              partsTagBadge.textContent = 'Not selected';
              partsTagBadge.setAttribute('data-status', 'empty');
              damagedPartBadge.textContent = 'Not selected';
              damagedPartBadge.setAttribute('data-status', 'empty');
              
              // Clear file storage
              clearWlpFileSelection('partsTag');
              clearWlpFileSelection('damagedPart');
              
              // Reset form fields
              form.reset();
              
              // Hide diagnostic panel
              document.getElementById('wlpPhotoDiagnostics').style.display = 'none';
              
              // Return to idle state after reset complete
              setTimeout(function() {
                setWlpState('idle');
                console.log('[WLP SUCCESS] Reset complete, returned to idle state');
              }, 500);
            }, 2000); // 2-second delay to show success message
          } else {
            // Server returned error - enter error state
            setWlpState('error');
            updateWlpDiagnostics();
            
            // Handle structured validation errors from backend
            if (response.errorType === 'VALIDATION' && response.missingFields && response.missingFields.length > 0) {
              var errorHtml = '<strong>Submission failed. Missing required fields:</strong><ul style="margin-top:8px;padding-left:20px;">';
              response.missingFields.forEach(function(field) {
                errorHtml += '<li>' + field + '</li>';
              });
              errorHtml += '</ul>';
              var msgDiv = document.getElementById('wlpMessage');
              msgDiv.innerHTML = errorHtml;
              msgDiv.className = 'message-box message-error';
              msgDiv.style.display = 'block';
            } else {
              showMessage('wlpMessage', response.message, true);
            }
          }
        })
        .withFailureHandler(function(error) {
          console.error('[WLP SUBMIT] Server error:', error);
          setWlpState('error');
          updateWlpDiagnostics();
          setButtonLoading('wlpSubmitBtn', false);
          showMessage('wlpMessage', 'Server error: ' + error.message, true);
        })
        .submitWLP(formData);
    }

    function resetWLPForm() {
      // Manual reset - go to idle state
      setWlpState('idle');
      
      document.getElementById('wlpForm').reset();
      clearWlpFileSelection('partsTag');
      clearWlpFileSelection('damagedPart');
      document.getElementById('wlpMessage').classList.remove('visible');
      
      // Reset badges
      var partsTagBadge = document.getElementById('diagPartsTagBadge');
      var damagedPartBadge = document.getElementById('diagDamagedPartBadge');
      if (partsTagBadge) {
        partsTagBadge.textContent = 'Not selected';
        partsTagBadge.setAttribute('data-status', 'empty');
      }
      if (damagedPartBadge) {
        damagedPartBadge.textContent = 'Not selected';
        damagedPartBadge.setAttribute('data-status', 'empty');
      }
      
      // Hide diagnostic panel
      document.getElementById('wlpPhotoDiagnostics').style.display = 'none';
    }

    // ================================================================
    //  WCF FORM: SUBMISSION
    // ================================================================

    async function submitWCFForm(event) {
      event.preventDefault();
      var form = event.target;
      if (!validateForm(form, 'wcf')) {
        showMessage('wcfMessage', 'Please fill in all required fields before submitting.', true);
        return;
      }
      if (!fileStorage.wcf) {
        showMessage('wcfMessage', 'Please attach an illustration image.', true);
        return;
      }

      setButtonLoading('wcfSubmitBtn', true);
      document.getElementById('wcfPdfDownload').style.display = 'none';

      // Upload illustration image
      var illustrationUrl = '';
      try {
        illustrationUrl = await uploadFile(fileStorage.wcf, 'wcf');
      } catch (error) {
        setButtonLoading('wcfSubmitBtn', false);
        showMessage('wcfMessage', 'Image upload failed: ' + error.message, true);
        return;
      }

      // Collect MC Usage
      var mcUsage = '';
      document.querySelectorAll('input[name="wcfMcUsage"]').forEach(function(r) {
        if (r.checked) mcUsage = r.value;
      });

      // Collect Part Supply Method
      var partSupply = [];
      document.querySelectorAll('input[name="wcfPartSupply"]:checked').forEach(function(cb) {
        partSupply.push(cb.value);
      });

      // Collect affected parts
      var affectedParts = [];
      document.querySelectorAll('#affectedPartsBody tr').forEach(function(row) {
        var partNo = row.querySelector('.part-no');
        var partName = row.querySelector('.part-name');
        var partQty = row.querySelector('.part-qty');
        
        if (partNo && partName && (partNo.value.trim() || partName.value.trim())) {
          // Collect checked supply methods for this part
          var supplyMethods = [];
          row.querySelectorAll('input[type="checkbox"]:checked').forEach(function(cb) {
            supplyMethods.push(cb.value);
          });
          
          affectedParts.push({
            partNo: partNo.value.trim(),
            partName: partName.value.trim(),
            qty: partQty ? partQty.value.trim() : '',
            supplyMethod: supplyMethods.join(', ')
          });
        }
      });

      var formData = {
        branch: document.getElementById('wcfBranch').value,
        preparedDate: formatDateToMMDDYYYY(document.getElementById('wcfPreparedDate').value),
        jobOrderNo: document.getElementById('wcfJobOrderNo').value.trim(),
        dealerName: document.getElementById('wcfDealerName').value.trim(),
        dealerAddress: document.getElementById('wcfDealerAddress').value.trim(),
        dealerPhone: document.getElementById('wcfDealerPhone').value.trim(),
        customerName: document.getElementById('wcfCustomerName').value.trim(),
        customerAddress: document.getElementById('wcfCustomerAddress').value.trim(),
        customerPhone: document.getElementById('wcfCustomerPhone').value.trim(),
        model: document.getElementById('wcfModel').value.trim(),
        color: document.getElementById('wcfColor').value.trim(),
        frameNo: document.getElementById('wcfFrameNo').value.trim(),
        engineNo: document.getElementById('wcfEngineNo').value.trim(),
        wrcNo: document.getElementById('wcfWrcNo').value.trim(),
        purchaseDate: formatDateToMMDDYYYY(document.getElementById('wcfPurchaseDate').value),
        failureDate: formatDateToMMDDYYYY(document.getElementById('wcfFailureDate').value),
        reportedDate: formatDateToMMDDYYYY(document.getElementById('wcfReportedDate').value),
        repairDate: formatDateToMMDDYYYY(document.getElementById('wcfRepairDate').value),
        mcUsage: mcUsage,
        mcUsageOther: document.getElementById('wcfMcUsageOther').value.trim(),
        kilometerRun: document.getElementById('wcfKilometerRun').value,
        problemComplaint: document.getElementById('wcfProblemComplaint').value.trim(),
        probableCause: document.getElementById('wcfProbableCause').value.trim(),
        correctiveAction: document.getElementById('wcfCorrectiveAction').value.trim(),
        suggestionRemarks: document.getElementById('wcfSuggestionRemarks').value.trim(),
        causalPartNo: document.getElementById('wcfCausalPartNo').value.trim(),
        causalPartName: document.getElementById('wcfCausalPartName').value.trim(),
        causalPartQty: document.getElementById('wcfCausalPartQty').value,
        partSupplyMethod: partSupply.join(', '),
        affectedParts: JSON.stringify(affectedParts),
        unitsSameProblem: document.getElementById('wcfUnitsSameProblem').value.trim(),
        deliverTo: document.getElementById('wcfDeliverTo').value.trim(),
        preparedByName: document.getElementById('wcfPreparedByName') ? document.getElementById('wcfPreparedByName').value.trim() : '',
        preparedBySignature: getSignatureData('wcfPreparedBySignature'),
        acknowledgedByName: document.getElementById('wcfAcknowledgedByName') ? document.getElementById('wcfAcknowledgedByName').value.trim() : '',
        acknowledgedBySignature: getSignatureData('wcfAcknowledgedBySignature'),
        warrantyRepairName: document.getElementById('wcfWarrantyRepairName') ? document.getElementById('wcfWarrantyRepairName').value.trim() : '',
        warrantyRepairSignature: getSignatureData('wcfWarrantyRepairSignature'),
        illustrationUrl: illustrationUrl,
        email: document.getElementById('wcfEmail').value.trim(),
        jobOrderNo: document.getElementById('wcfJobOrderNo').value.trim()
      };

      google.script.run
        .withSuccessHandler(function(response) {
          setButtonLoading('wcfSubmitBtn', false);
          if (response.success) {
            // Show success message with user email status detail
            var successMsg = response.message;
            if (response.userEmailStatus === 'SENT') {
              successMsg += ' (Thank-you email sent to your inbox)';
            } else if (response.userEmailStatus === 'FAILED') {
              successMsg += ' (Warning: thank-you email failed: ' + (response.userEmailError || 'unknown error') + ')';
            } else if (response.userEmailStatus === 'SKIPPED') {
              successMsg += ' (User email skipped: ' + (response.userEmailError || 'no email') + ')';
            }
            showMessage('wcfMessage', successMsg, false);
            
            // Store data for modal with reliable Drive URLs
            window.wcfSubmitData = {
              wcfId: response.wcfId,
              pdfUrl: response.pdfUrl,
              pdfFileId: response.pdfFileId,
              previewUrl: response.previewUrl,  // Drive preview URL
              downloadUrl: response.downloadUrl,  // Drive download URL
              branch: response.branch,
              jobOrderNo: formData.jobOrderNo,
              userEmailStatus: response.userEmailStatus || 'unknown',
              userEmailError: response.userEmailError || '',
              userEmailSentAt: response.userEmailSentAt || ''
            };
            
            // Show modal instead of inline PDF download
            showWcfModal(response);
            
            // Reset form and clear signatures
            form.reset();
            clearFileSelection('wcf');
            clearSignature('wcfPreparedBySignature');
            clearSignature('wcfAcknowledgedBySignature');
            clearSignature('wcfWarrantyRepairSignature');
            document.getElementById('wcfMcUsageOther').style.display = 'none';
          } else {
            // Handle structured validation errors from backend
            if (response.errorType === 'VALIDATION' && response.missingFields && response.missingFields.length > 0) {
              var errorHtml = '<strong>Submission failed. Missing required fields:</strong><ul style="margin-top:8px;padding-left:20px;">';
              response.missingFields.forEach(function(field) {
                errorHtml += '<li>' + field + '</li>';
              });
              errorHtml += '</ul>';
              var msgDiv = document.getElementById('wcfMessage');
              msgDiv.innerHTML = errorHtml;
              msgDiv.className = 'message-box message-error';
              msgDiv.style.display = 'block';
            } else {
              showMessage('wcfMessage', response.message, true);
            }
          }
        })
        .withFailureHandler(function(error) {
          setButtonLoading('wcfSubmitBtn', false);
          showMessage('wcfMessage', 'Server error: ' + error.message, true);
        })
        .submitWCF(formData);
    }

    function resetWCFForm() {
      document.getElementById('wcfForm').reset();
      clearFileSelection('wcf');
      document.getElementById('wcfMessage').classList.remove('visible');
      document.getElementById('wcfMcUsageOther').style.display = 'none';
      clearSignature('wcfPreparedBySignature');
      clearSignature('wcfAcknowledgedBySignature');
      clearSignature('wcfWarrantyRepairSignature');
      // Reset affected parts table to single row
      var tbody = document.getElementById('affectedPartsBody');
      tbody.innerHTML = '<tr>'
        + '<td><input type="text" placeholder="Part No."></td>'
        + '<td><input type="text" placeholder="Part Name"></td>'
        + '<td><input type="number" min="0" placeholder="0"></td>'
        + '<td><button type="button" class="btn-remove-row" onclick="removeAffectedPartRow(this)" title="Remove row">&times;</button></td>'
        + '</tr>';
    }

    // ================================================================
    //  WCF: MC USAGE TOGGLE
    // ================================================================

    function toggleMcUsageOther() {
      var othersRadio = document.querySelector('input[name="wcfMcUsage"][value="Others"]');
      var otherInput = document.getElementById('wcfMcUsageOther');
      if (othersRadio && otherInput) {
        otherInput.style.display = othersRadio.checked ? 'block' : 'none';
        if (!othersRadio.checked) otherInput.value = '';
      }
    }

    // ================================================================
    //  WCF: AFFECTED PARTS TABLE MANAGEMENT
    // ================================================================

    function addAffectedPartRow() {
      var tbody = document.getElementById('affectedPartsBody');
      var tr = document.createElement('tr');
      tr.innerHTML = '<td><input type="text" class="part-no" placeholder="Part No."></td>'
        + '<td><input type="text" class="part-name" placeholder="Part Name"></td>'
        + '<td><input type="number" class="part-qty" min="0" placeholder="0"></td>'
        + '<td><div class="checkbox-group" style="display:flex;flex-wrap:wrap;gap:4px;font-size:0.75rem;">'
        + '<label class="checkbox-label" style="margin:0;white-space:nowrap;"><input type="checkbox" class="supply-kmpc" value="KMPC H.O."> KMPC H.O.</label>'
        + '<label class="checkbox-label" style="margin:0;white-space:nowrap;"><input type="checkbox" class="supply-ksc" value="KSC"> KSC</label>'
        + '<label class="checkbox-label" style="margin:0;white-space:nowrap;"><input type="checkbox" class="supply-dealer" value="SP Dealer"> SP Dealer</label>'
        + '<label class="checkbox-label" style="margin:0;white-space:nowrap;"><input type="checkbox" class="supply-stock" value="Use Stock"> Warranty Stock</label>'
        + '</div></td>'
        + '<td><button type="button" class="btn-remove-row" onclick="removeAffectedPartRow(this)" title="Remove row">&times;</button></td>';
      tbody.appendChild(tr);
    }

    function removeAffectedPartRow(btn) {
      var tbody = document.getElementById('affectedPartsBody');
      if (tbody.rows.length > 1) {
        btn.closest('tr').remove();
      }
    }

    // ================================================================
    //  WCF: SIGNATURE PAD HANDLING
    // ================================================================

    // Global signature pad state
    var signaturePads = {};

    function initSignaturePad(canvasId) {
      var canvas = document.getElementById(canvasId);
      if (!canvas) return;

      var ctx = canvas.getContext('2d');
      var drawing = false;
      var lastX = 0;
      var lastY = 0;

      signaturePads[canvasId] = {
        canvas: canvas,
        ctx: ctx,
        isEmpty: true
      };

      function getPos(e) {
        var rect = canvas.getBoundingClientRect();
        var scaleX = canvas.width / rect.width;
        var scaleY = canvas.height / rect.height;
        
        if (e.touches && e.touches.length > 0) {
          return {
            x: (e.touches[0].clientX - rect.left) * scaleX,
            y: (e.touches[0].clientY - rect.top) * scaleY
          };
        }
        return {
          x: (e.clientX - rect.left) * scaleX,
          y: (e.clientY - rect.top) * scaleY
        };
      }

      function startDrawing(e) {
        e.preventDefault();
        drawing = true;
        var pos = getPos(e);
        lastX = pos.x;
        lastY = pos.y;
      }

      function draw(e) {
        if (!drawing) return;
        e.preventDefault();
        
        var pos = getPos(e);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        
        lastX = pos.x;
        lastY = pos.y;
        signaturePads[canvasId].isEmpty = false;
      }

      function stopDrawing() {
        drawing = false;
      }

      // Mouse events
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);

      // Touch events
      canvas.addEventListener('touchstart', startDrawing);
      canvas.addEventListener('touchmove', draw);
      canvas.addEventListener('touchend', stopDrawing);
    }

    function clearSignature(canvasId) {
      var pad = signaturePads[canvasId];
      if (pad && pad.canvas && pad.ctx) {
        pad.ctx.clearRect(0, 0, pad.canvas.width, pad.canvas.height);
        pad.isEmpty = true;
      }
    }

    function getSignatureData(canvasId) {
      var pad = signaturePads[canvasId];
      if (!pad || pad.isEmpty) return '';
      try {
        return pad.canvas.toDataURL('image/png');
      } catch (e) {
        console.error('Error getting signature data:', e);
        return '';
      }
    }

    // ================================================================
    //  WCF: POST-SUBMIT MODAL
    // ================================================================

    function showWcfModal(responseData) {
      document.getElementById('wcfModalId').textContent = responseData.wcfId || '-';
      document.getElementById('wcfModalJobOrder').textContent = responseData.jobOrderNo || '-';
      document.getElementById('wcfModalBranch').textContent = responseData.branch || '-';
      
      // Show user email status in modal
      var status = document.getElementById('wcfModalStatus');
      status.className = 'wcf-modal-status';
      if (responseData.userEmailStatus === 'SENT') {
        status.textContent = ' Thank-you email sent to your inbox';
        status.className = 'wcf-modal-status show success';
      } else if (responseData.userEmailStatus === 'FAILED') {
        status.textContent = ' Thank-you email failed: ' + (responseData.userEmailError || 'unknown');
        status.className = 'wcf-modal-status show error';
      } else if (responseData.userEmailStatus === 'SKIPPED') {
        status.textContent = ' User email skipped: ' + (responseData.userEmailError || 'N/A');
        status.className = 'wcf-modal-status show';
      } else {
        status.textContent = '';
      }
      
      // Enable all buttons
      document.getElementById('wcfBtnPreview').disabled = false;
      document.getElementById('wcfBtnDownload').disabled = false;
      document.getElementById('wcfBtnEmail').disabled = false;
      
      // Show modal
      document.getElementById('wcfSubmitModal').classList.add('active');
    }

    function closeWcfModal() {
      document.getElementById('wcfSubmitModal').classList.remove('active');
    }

    function previewWcfPdf() {
      // Use reliable Drive preview URL if available, fallback to pdfUrl
      if (window.wcfSubmitData) {
        var url = window.wcfSubmitData.previewUrl || window.wcfSubmitData.pdfUrl;
        if (url) {
          window.open(url, '_blank');
        } else {
          showWcfModalStatus('PDF preview URL not available', false);
        }
      }
    }

    function downloadWcfPdf() {
      // Use reliable Drive download URL if available, fallback to pdfUrl
      if (window.wcfSubmitData) {
        var url = window.wcfSubmitData.downloadUrl || window.wcfSubmitData.pdfUrl;
        if (url) {
          window.open(url, '_blank');
        } else {
          showWcfModalStatus('PDF download URL not available', false);
        }
      }
    }

    function sendWcfEmail() {
      if (!window.wcfSubmitData || !window.wcfSubmitData.wcfId) {
        showWcfModalStatus('No WCF data available', false);
        return;
      }

      var btn = document.getElementById('wcfBtnEmail');
      var originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = ' Sending...';

      google.script.run
        .withSuccessHandler(function(response) {
          btn.disabled = false;
          btn.innerHTML = originalText;
          
          if (response.success) {
            showWcfModalStatus('Email sent successfully to: ' + response.recipients.join(', '), true);
            btn.disabled = true; // Prevent sending multiple times
            btn.innerHTML = ' Email Sent';
          } else {
            showWcfModalStatus('Failed to send email: ' + response.message, false);
          }
        })
        .withFailureHandler(function(error) {
          btn.disabled = false;
          btn.innerHTML = originalText;
          showWcfModalStatus('Error sending email: ' + error.message, false);
        })
        .sendWcfEmailManual(window.wcfSubmitData.wcfId);
    }

    function showWcfModalStatus(message, isSuccess) {
      var status = document.getElementById('wcfModalStatus');
      status.textContent = message;
      status.className = 'wcf-modal-status show ' + (isSuccess ? 'success' : 'error');
    }

    // ================================================================
    //  DYNAMIC DROPDOWN POPULATION
    // ================================================================

    function loadProvinces() {
      google.script.run
        .withSuccessHandler(function(provinces) {
          var select = document.getElementById('province');
          while (select.options.length > 1) select.remove(1);
          provinces.forEach(function(prov) {
            var option = document.createElement('option');
            option.value = prov;
            option.textContent = prov;
            select.appendChild(option);
          });
        })
        .withFailureHandler(function(error) { console.error('Failed to load provinces:', error); })
        .getProvinces();
    }

    // ================================================================
    //  PAGE INITIALIZATION
    // ================================================================

    window.addEventListener('DOMContentLoaded', function() {
      loadProvinces();
      
      // FSC-only: Load auto-generated transmittal number on page load
      loadFscTransmittalNumber();

      document.querySelectorAll('input[required], select[required], textarea[required]').forEach(function(el) {
        el.addEventListener('blur', function() { validateField(this); });
        el.addEventListener('focus', function() {
          this.classList.remove('field-error');
          var err = this.parentElement.querySelector('.error-message');
          if (err) err.remove();
        });
        el.addEventListener('input', function() {
          if (this.value.trim() !== '') {
            this.classList.remove('field-error');
            var err = this.parentElement.querySelector('.error-message');
            if (err) err.remove();
          }
        });
      });

      document.querySelectorAll('input, select, textarea').forEach(function(el) {
        el.addEventListener('input', function() {
          var formType = this.form ? this.form.id.replace('Form','') : '';
          var banner = document.getElementById(formType + 'ValidationBanner');
          if (banner && banner.classList.contains('visible')) {
            var allFilled = Array.from(this.form.querySelectorAll('[required]')).every(function(field) {
              if (field.type === 'file') return field.files && field.files.length > 0;
              if (field.tagName === 'SELECT') return field.value !== '';
              return field.value.trim() !== '';
            });
            if (allFilled) banner.classList.remove('visible');
          }
        });
      });
    });

    // ================================================================
    //  WRC HELP MODAL
    // ================================================================

    function openWrcHelpModal() {
      var modal = document.getElementById('wrcHelpModal');
      modal.classList.add('active');
      modal.setAttribute('aria-hidden','false');
      setTimeout(function() { document.getElementById('modalCloseBtn').focus(); }, 100);
    }

    function closeWrcHelpModal() {
      var modal = document.getElementById('wrcHelpModal');
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden','true');
    }

    document.addEventListener('DOMContentLoaded', function() {
      var overlay = document.getElementById('wrcHelpModal');
      if (overlay) {
        overlay.addEventListener('click', function(e) { if (e.target === overlay) closeWrcHelpModal(); });
      }
      
      // Global Escape key handler for all modals
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          // Close WCF submit modal if open
          var wcfModal = document.getElementById('wcfSubmitModal');
          if (wcfModal && wcfModal.classList.contains('active')) {
            closeWcfModal();
            return;
          }
          // Close WRC help modal if open
          closeWrcHelpModal();
        }
      });

      // WCF: MC Usage radio change listeners
      document.querySelectorAll('input[name="wcfMcUsage"]').forEach(function(radio) {
        radio.addEventListener('change', toggleMcUsageOther);
      });

      // WCF: Initialize signature pads
      initSignaturePad('wcfPreparedBySignature');
      initSignaturePad('wcfAcknowledgedBySignature');
      initSignaturePad('wcfWarrantyRepairSignature');
      
      // WCF: Close modal on overlay click
      var wcfModal = document.getElementById('wcfSubmitModal');
      if (wcfModal) {
        wcfModal.addEventListener('click', function(e) {
          if (e.target === wcfModal) closeWcfModal();
        });
      }
    });
  </script>

  <!-- WRC Help Modal -->
  <div id="wrcHelpModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-header">
        <h3 id="modalTitle" class="modal-title">Don't Have a WRC Number?</h3>
        <button type="button" class="modal-close" id="modalCloseBtn" onclick="closeWrcHelpModal()" aria-label="Close dialog">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-text">
          If you do not have the PHYSICAL WRC BARCODE, please email the following details to:
          <br>
          <a href="mailto:NolanRalph_P@kmp.com.ph" class="modal-email">NolanRalph_P@kmp.com.ph</a>
        </p>
        <p>SUBJECT: WRC BARCODE REQUEST</p>
        <div class="required-details">
          <h4>Required Details:</h4>
          <ul>
            <li>VIN/CHASSIS NUMBER</li>
            <li>ENGINE NUMBER</li>
            <li>DEALER NAME (GIANT MOTO PRO)</li>
            <li>COMPLETE SHIPPING ADDRESS (BRANCH ADDRESS)</li>
            <li>NAME OF RECIPIENT OR RECEIVER (BRANCH MANAGER)</li>
            <li>CONTACT NUMBER</li>
          </ul>
          <br>
          <p>MUST DO:</p>
          <p>To get the WRC CODE while waiting for the WRC Barcode, kindly send text to Sir Nolan Ralph T. Pablo at 0998-847-8687 with the ff format:</p>
          <br>
          <p>Good day Sir.<br>
          We would like to ask for the WRC Code of this unit (MODEL NAME) with Chassis Number: while waiting for the physical barcode.<br>
          This is for us to declare our unit sell-out of the day. We have also sent an email requesting for the physical barcode.<br>
          Thank you and have a good day.</p>
          <br>
          <p>Giant Moto Pro Corp. - (Branch Name)</p>
        </div>
        <div class="modal-actions">
          <a href="mailto:NolanRalph_P@kmp.com.ph?subject=Request%20for%20WRC%20Number&body=VIN%2FCHASSIS%20NUMBER%3A%0A%0AENGINE%20NUMBER%3A%0A%0ADEALER%20NAME%3A%20GIANT%20MOTO%20PRO%0A%0ACOMPLETE%20SHIPPING%20ADDRESS%20(BRANCH%20ADDRESS)%3A%0A%0ANAME%20OF%20RECIPIENT%20OR%20RECEIVER%20(BRANCH%20MANAGER)%3A%0A%0ACONTACT%20NUMBER%3A%0A" class="btn-email" role="button">Open Email Client</a>
          <button type="button" class="btn-cancel" onclick="closeWrcHelpModal()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- WCF Post-Submit Modal -->
  <div id="wcfSubmitModal" class="wcf-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="wcfModalTitle">
    <div class="wcf-modal">
      <div class="wcf-modal-header">
        <h2 id="wcfModalTitle" class="wcf-modal-title">
          <span style="font-size:2rem"></span>
          WCF Submission Successful
        </h2>
      </div>
      <div class="wcf-modal-body">
        <div class="wcf-modal-info">
          <div class="wcf-modal-info-row">
            <span class="wcf-modal-info-label">WCF ID:</span>
            <span class="wcf-modal-info-value" id="wcfModalId">-</span>
          </div>
          <div class="wcf-modal-info-row">
            <span class="wcf-modal-info-label">Job Order No.:</span>
            <span class="wcf-modal-info-value" id="wcfModalJobOrder">-</span>
          </div>
          <div class="wcf-modal-info-row">
            <span class="wcf-modal-info-label">Branch:</span>
            <span class="wcf-modal-info-value" id="wcfModalBranch">-</span>
          </div>
        </div>

        <div class="wcf-modal-status" id="wcfModalStatus"></div>

        <div class="wcf-modal-actions">
          <button type="button" class="wcf-modal-btn wcf-modal-btn-primary" id="wcfBtnPreview" onclick="previewWcfPdf()">
             Preview PDF
          </button>
          <button type="button" class="wcf-modal-btn wcf-modal-btn-primary" id="wcfBtnDownload" onclick="downloadWcfPdf()">
             Download PDF
          </button>
          <button type="button" class="wcf-modal-btn wcf-modal-btn-success" id="wcfBtnEmail" onclick="sendWcfEmail()">
             Send to Email
          </button>
          <button type="button" class="wcf-modal-btn wcf-modal-btn-secondary" onclick="closeWcfModal()">
            Done
          </button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
